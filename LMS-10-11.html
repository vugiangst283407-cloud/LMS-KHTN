<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPlatform AI - ƒêƒÉng nh·∫≠p</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.5.0/mammoth.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light gray-blue background */
            color: #1e293b; /* Slate 800 */
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* Modal base styles */
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .hidden-modal {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        .visible-modal {
            opacity: 1;
            transform: scale(1);
            pointer-events: all;
        }
        
        /* Tab styles */
        .tab-button {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .tab-button.active {
            border-bottom-color: #4f46e5; /* Indigo 600 */
            color: #4f46e5;
        }
        
        /* Custom game card */
        .game-card {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        /* Memory game card */
        .memory-card {
            width: 100px;
            height: 100px;
            perspective: 1000px;
        }
        .memory-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .memory-card.is-flipped .memory-card-inner {
            transform: rotateY(180deg);
        }
        .memory-card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .memory-card-front {
            background-color: #6366f1; /* Indigo 500 */
            color: white;
            font-size: 2rem;
        }
        .memory-card-back {
            background-color: #f1f5f9; /* Slate 100 */
            color: #4f46e5;
            font-size: 2.5rem;
            transform: rotateY(180deg);
        }
        .memory-card.is-matched {
            opacity: 0.5;
            pointer-events: none;
        }

        /* File Upload Area */
        .file-upload-area {
            border: 2px dashed #cbd5e1; /* Slate 300 */
            background-color: #f8fafc; /* Slate 50 */
            transition: all 0.3s ease;
        }
        .file-upload-area:hover, .file-upload-area.dragover {
            border-color: #4f46e5; /* Indigo 600 */
            background-color: #eef2ff; /* Indigo 50 */
        }
        
        /* M·ªöI: CSS cho Giao di·ªán L√†m b√†i t·∫≠p */
        .exercise-container.answered .answer-option {
            cursor: not-allowed;
            opacity: 0.8;
        }
        .answer-option.selected {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
        .exercise-container.answered .answer-option.correct {
            border-color: #22c55e;
            background-color: #dcfce7;
            color: #166534;
            font-weight: 600;
        }
        .exercise-container.answered .answer-option.incorrect-selection {
            border-color: #ef4444;
            background-color: #fee2e2;
            color: #991b1b;
        }
        .exercise-container.answered .answer-option:not(.selected):not(.correct) {
             opacity: 0.6;
        }
        /* Hi·ªáu ·ª©ng rung l·∫Øc khi sai */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake-incorrect {
            animation: shake 0.3s ease-in-out;
        }
        
        /* Notification */
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            z-index: 100;
            transition: transform 0.5s ease, opacity 0.5s ease;
            transform: translateX(120%);
            opacity: 0;
        }
        #notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        #notification.success { background-color: #22c55e; } /* Green 500 */
        #notification.error { background-color: #ef4444; } /* Red 500 */
        #notification.warning { background-color: #f59e0b; } /* Amber 500 */
        #notification.info { background-color: #3b82f6; } /* Blue 500 */

    </style>
</head>
<body class="bg-gray-100">

    <!-- NEW: Login View -->
    <div id="login-view" class="flex items-center justify-center h-screen">
        <div class="bg-white p-10 rounded-lg shadow-xl w-full max-w-sm text-center">
            <i class="fas fa-graduation-cap text-5xl text-indigo-600 mb-6"></i>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">EduPlatform AI</h1>
            <p class="text-gray-600 mb-8">Vui l√≤ng ch·ªçn vai tr√≤ c·ªßa b·∫°n</p>
            <div class="space-y-4">
                <button id="loginAsAdminBtn" class="w-full py-3 px-4 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                    <i class="fas fa-user-shield mr-2"></i>
                    ƒêƒÉng nh·∫≠p (Qu·∫£n tr·ªã vi√™n)
                </button>
                <hr class="my-4">
                <!-- Student Login Form -->
                <form id="student-login-form" class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 text-left">T√™n ƒëƒÉng nh·∫≠p (HS)</label>
                        <input type="text" id="username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., vanan_6a1" required>
                    </div>
                    <button type="submit" class="w-full py-3 px-4 bg-yellow-600 text-white rounded-lg font-semibold hover:bg-yellow-700 transition-colors">
                        <i class="fas fa-user-graduate mr-2"></i>
                        ƒêƒÉng nh·∫≠p (H·ªçc sinh)
                    </button>
                </form>
                <p id="student-login-loading" class="text-sm text-gray-500 hidden"><i class="fas fa-spinner fa-spin mr-2"></i>ƒêang t·∫£i d·ªØ li·ªáu, vui l√≤ng ch·ªù...</p>
            </div>
        </div>
    </div>

    <!-- NEW: Admin Portal Wrapper -->
    <div id="admin-portal" class="hidden flex h-screen">
        <!-- Admin Sidebar -->
        <nav class="w-20 lg:w-64 bg-white shadow-lg flex flex-col transition-all duration-300">
            <div class="h-20 flex items-center justify-center px-6">
                <i class="fas fa-user-shield text-3xl text-indigo-600"></i>
                <span class="text-2xl font-bold text-indigo-600 ml-3 hidden lg:block">Admin</span>
            </div>
            <ul class="flex-1 px-4 py-4 space-y-2">
                <li>
                    <a href="#dashboard" class="admin-sidebar-link active flex items-center justify-center lg:justify-start p-3 rounded-lg text-gray-500 hover:bg-indigo-50 hover:text-indigo-600" data-view="dashboard">
                        <i class="fas fa-tachometer-alt fa-fw text-xl"></i>
                        <span class="ml-4 font-medium hidden lg:block">B·∫£ng ƒëi·ªÅu khi·ªÉn</span>
                    </a>
                </li>
                <li>
                    <a href="#students" class="admin-sidebar-link flex items-center justify-center lg:justify-start p-3 rounded-lg text-gray-500 hover:bg-indigo-50 hover:text-indigo-600" data-view="students">
                        <i class="fas fa-users fa-fw text-xl"></i>
                        <span class="ml-4 font-medium hidden lg:block">H·ªçc sinh</span>
                    </a>
                </li>
                <li>
                    <a href="#lessons" class="admin-sidebar-link flex items-center justify-center lg:justify-start p-3 rounded-lg text-gray-500 hover:bg-indigo-50 hover:text-indigo-600" data-view="lessons">
                        <i class="fas fa-book-open fa-fw text-xl"></i>
                        <span class="ml-4 font-medium hidden lg:block">B√†i h·ªçc</span>
                    </a>
                </li>
                <li>
                    <a href="#exercises" class="admin-sidebar-link flex items-center justify-center lg:justify-start p-3 rounded-lg text-gray-500 hover:bg-indigo-50 hover:text-indigo-600" data-view="exercises">
                        <i class="fas fa-pencil-alt fa-fw text-xl"></i>
                        <span class="ml-4 font-medium hidden lg:block">B√†i t·∫≠p</span>
                    </a>
                </li>
                <li>
                    <a href="#games" class="admin-sidebar-link flex items-center justify-center lg:justify-start p-3 rounded-lg text-gray-500 hover:bg-indigo-50 hover:text-indigo-600" data-view="games">
                        <i class="fas fa-gamepad fa-fw text-xl"></i>
                        <span class="ml-4 font-medium hidden lg:block">Tr√≤ ch∆°i</span>
                    </a>
                </li>
                <li>
                    <a href="#sheets" class="admin-sidebar-link flex items-center justify-center lg:justify-start p-3 rounded-lg text-gray-500 hover:bg-indigo-50 hover:text-indigo-600" data-view="sheets">
                        <i class="fas fa-sheet-plastic fa-fw text-xl"></i>
                        <span class="ml-4 font-medium hidden lg:block">Google Sheets</span>
                    </a>
                </li>
                <li>
                    <a href="#ai-tutor" class="admin-sidebar-link flex items-center justify-center lg:justify-start p-3 rounded-lg text-gray-500 hover:bg-indigo-50 hover:text-indigo-600" data-view="ai-tutor">
                        <i class="fas fa-robot fa-fw text-xl"></i>
                        <span class="ml-4 font-medium hidden lg:block">Gia s∆∞ AI</span>
                    </a>
                </li>
                <!-- M·ªöI: Th√™m B·∫£ng x·∫øp h·∫°ng -->
                <li>
                    <a href="#leaderboard" class="admin-sidebar-link flex items-center justify-center lg:justify-start p-3 rounded-lg text-gray-500 hover:bg-indigo-50 hover:text-indigo-600" data-view="leaderboard">
                        <i class="fas fa-trophy fa-fw text-xl"></i>
                        <span class="ml-4 font-medium hidden lg:block">B·∫£ng x·∫øp h·∫°ng</span>
                    </a>
                </li>
            </ul>
            <div class="px-4 py-4">
                <a href="#logout" id="adminLogoutBtn" class="flex items-center justify-center lg:justify-start p-3 rounded-lg text-red-600 bg-red-50 hover:bg-red-100" data-view="logout">
                    <i class="fas fa-sign-out-alt fa-fw text-xl"></i>
                    <span class="ml-4 font-medium hidden lg:block">ƒêƒÉng xu·∫•t</span>
                </a>
            </div>
        </nav>

        <!-- Admin Main Content -->
        <main class="flex-1 h-screen overflow-y-auto">
            <!-- Admin Header -->
            <header class="h-20 bg-white shadow-sm flex items-center justify-between px-6">
                <h1 id="admin-view-title" class="text-2xl font-bold text-gray-800">B·∫£ng ƒëi·ªÅu khi·ªÉn</h1>
                <div class="flex items-center space-x-4">
                    <button class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-bell text-xl"></i>
                    </button>
                    <div class="flex items-center">
                        <img src="https://placehold.co/40x40/6366f1/white?text=A" alt="Admin" class="w-10 h-10 rounded-full">
                        <span class="ml-3 font-medium text-gray-700 hidden md:block">Admin</span>
                    </div>
                </div>
            </header>

            <!-- Admin Page Content -->
            <div class="p-6 space-y-6">
                
                <!-- Dashboard View -->
                <div id="dashboard-view" class="admin-view-content space-y-6">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center space-x-4">
                            <div class="p-3 rounded-full bg-indigo-100">
                                <i class="fas fa-users text-2xl text-indigo-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">T·ªïng H·ªçc sinh</p>
                                <p class="text-3xl font-bold text-gray-800" id="total-students">0</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center space-x-4">
                            <div class="p-3 rounded-full bg-green-100">
                                <i class="fas fa-book-open text-2xl text-green-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">T·ªïng B√†i h·ªçc</p>
                                <p class="text-3xl font-bold text-gray-800" id="total-lessons">0</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center space-x-4">
                            <div class="p-3 rounded-full bg-yellow-100">
                                <i class="fas fa-check-circle text-2xl text-yellow-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">T·ªïng B√†i t·∫≠p</p>
                                <p id="total-exercises" class="text-3xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center space-x-4">
                            <div class="p-3 rounded-full bg-red-100">
                                <i class="fas fa-chart-line text-2xl text-red-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">T·ªïng Tr√≤ ch∆°i</p>
                                <p id="total-games" class="text-3xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>
                    <!-- Chart -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">Ho·∫°t ƒë·ªông c·ªßa H·ªçc sinh</h2>
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>

                <!-- Students View -->
                <div id="students-view" class="admin-view-content hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">Danh s√°ch H·ªçc sinh</h2>
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">T√™n</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">T√™n ƒëƒÉng nh·∫≠p</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">L·ªõp</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">XP</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="student-list" class="divide-y divide-gray-200">
                                <!-- Student rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Lessons View -->
                <div id="lessons-view" class="admin-view-content hidden">
                    <div class="flex justify-end mb-4">
                        <button id="openLessonModalBtn" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">
                            <i class="fas fa-plus mr-2"></i>T·∫°o B√†i h·ªçc m·ªõi
                        </button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">Danh s√°ch B√†i h·ªçc</h2>
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">Ti√™u ƒë·ªÅ</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">Ch·ªß ƒë·ªÅ</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">Kh·ªëi</th> <!-- M·ªöI -->
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="lesson-list" class="divide-y divide-gray-200">
                                <!-- Lesson rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Exercises View -->
                <div id="exercises-view" class="admin-view-content hidden">
                    <div class="flex justify-end mb-4">
                        <button id="openExerciseModalBtn" class="px-5 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700">
                            <i class="fas fa-plus mr-2"></i>T·∫°o B√†i t·∫≠p m·ªõi
                        </button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">Danh s√°ch B√†i t·∫≠p</h2>
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">B√†i h·ªçc Li√™n quan</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">S·ªë c√¢u h·ªèi</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">Kh·ªëi</th> <!-- M·ªöI -->
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="exercise-list" class="divide-y divide-gray-200">
                                <!-- Exercise rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Games View -->
                <div id="games-view" class="admin-view-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Memory Game Card -->
                        <div id="createMemoryGameBtn" class="game-card p-6 rounded-lg text-white shadow-lg cursor-pointer">
                            <i class="fas fa-brain text-4xl mb-3"></i>
                            <h3 class="text-2xl font-bold mb-2">Tr√≤ ch∆°i L·∫≠t th·∫ª</h3>
                            <p>T·∫°o tr√≤ ch∆°i l·∫≠t th·∫ª ghi nh·ªõ t·ª´ v·ª±ng ho·∫∑c kh√°i ni·ªám.</p>
                        </div>
                        <!-- Custom Game Card -->
                        <div id="createCustomGameBtn" class="game-card p-6 rounded-lg text-white shadow-lg cursor-pointer" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%);">
                            <i class="fas fa-code text-4xl mb-3"></i>
                            <h3 class="text-2xl font-bold mb-2">Tr√≤ ch∆°i T√πy ch·ªânh</h3>
                            <p>T·ª± t·∫°o tr√≤ ch∆°i b·∫±ng HTML, CSS, v√† JavaScript.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Google Sheets View -->
                <div id="sheets-view" class="admin-view-content hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">T√≠ch h·ª£p Google Sheets</h2>
                        <p class="text-gray-600 mb-4">
                            ·ª®ng d·ª•ng n√†y hi·ªán ƒëang s·ª≠ d·ª•ng Google Apps Script (GAS) ƒë·ªÉ l∆∞u tr·ªØ. 
                            URL c·ªßa GAS ƒëang ƒë∆∞·ª£c ƒë·∫∑t trong bi·∫øn `GAS_WEB_APP_URL` trong m√£ ngu·ªìn.
                        </p>
                        <p class="text-gray-600 mb-4">
                            B·∫°n kh√¥ng c·∫ßn nh·∫≠p Sheet ID ·ªü ƒë√¢y n·ªØa. ƒê·ªÉ nh·∫≠p/xu·∫•t, vui l√≤ng ch·ªânh s·ª≠a tr·ª±c ti·∫øp Google Sheet ƒë√£ k·∫øt n·ªëi v·ªõi GAS.
                        </p>
                    </div>
                </div>
                
                <!-- AI Tutor View -->
                <div id="ai-tutor-view" class="admin-view-content hidden">
                    <div class="bg-white rounded-lg shadow-md max-w-3xl mx-auto h-[70vh] flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h2 class="text-xl font-semibold text-gray-700">Gia s∆∞ AI</h2>
                            <div>
                                <label for="admin-ai-grade" class="text-sm font-medium text-gray-700 mr-2">H·ªó tr·ª£ cho:</label>
                                <select id="admin-ai-grade" class="px-3 py-1 border border-gray-300 rounded-md shadow-sm">
                                    <option value="L·ªõp 6">L·ªõp 6</option>
                                    <option value="L·ªõp 7">L·ªõp 7</option>
                                    <option value="L·ªõp 8">L·ªõp 8</option>
                                    <option value="L·ªõp 9">L·ªõp 9</option>
                                </select>
                            </div>
                        </div>
                        <div id="ai-chat-box" class="flex-1 p-6 space-y-4 overflow-y-auto">
                            <!-- AI Welcome Message -->
                            <div class="flex justify-start">
                                <div class="p-3 rounded-lg bg-gray-100 text-gray-800 max-w-lg">
                                    <p>Xin ch√†o! T√¥i l√† Gia s∆∞ AI. B·∫°n mu·ªën h·ªèi v·ªÅ ch·ªß ƒë·ªÅ g√¨ h√¥m nay?</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border-t">
                            <form id="ai-chat-form" class="flex space-x-3">
                                <input type="text" id="ai-chat-input" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n...">
                                <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">G·ª≠i</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- M·ªöI: Admin Leaderboard View -->
                <div id="leaderboard-view" class="admin-view-content hidden space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">B·∫£ng x·∫øp h·∫°ng XP</h2>
                        
                        <!-- Filter Buttons -->
                        <div id="admin-leaderboard-filters" class="flex space-x-2 mb-4">
                            <button class="admin-lb-filter active px-4 py-2 text-sm font-medium rounded-lg bg-indigo-600 text-white" data-grade="all">T·∫•t c·∫£</button>
                            <button class="admin-lb-filter px-4 py-2 text-sm font-medium rounded-lg bg-gray-200 text-gray-700" data-grade="6">Kh·ªëi 6</button>
                            <button class="admin-lb-filter px-4 py-2 text-sm font-medium rounded-lg bg-gray-200 text-gray-700" data-grade="7">Kh·ªëi 7</button>
                            <button class="admin-lb-filter px-4 py-2 text-sm font-medium rounded-lg bg-gray-200 text-gray-700" data-grade="8">Kh·ªëi 8</button>
                            <button class="admin-lb-filter px-4 py-2 text-sm font-medium rounded-lg bg-gray-200 text-gray-700" data-grade="9">Kh·ªëi 9</button>
                        </div>
                        
                        <!-- Leaderboard Table -->
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600 w-16">H·∫°ng</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">T√™n</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">L·ªõp</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">XP</th>
                                </tr>
                            </thead>
                            <tbody id="admin-leaderboard-list" class="divide-y divide-gray-200">
                                <!-- Leaderboard rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>
    
    <!-- NEW: Student Portal Wrapper -->
    <div id="student-portal" class="hidden flex h-screen">
        <!-- Student Sidebar -->
        <nav class="w-20 lg:w-64 bg-white shadow-lg flex flex-col transition-all duration-300">
            <div class="h-20 flex items-center justify-center px-6">
                <i class="fas fa-user-graduate text-3xl text-yellow-600"></i>
                <span class="text-2xl font-bold text-yellow-700 ml-3 hidden lg:block">G√≥c h·ªçc t·∫≠p</span>
            </div>
            <ul class="flex-1 px-4 py-4 space-y-2">
                <li>
                    <a href="#student-dashboard" class="student-sidebar-link active flex items-center justify-center lg:justify-start p-3 rounded-lg text-gray-500 hover:bg-yellow-50 hover:text-yellow-600" data-view="student-dashboard">
                        <i class="fas fa-home fa-fw text-xl"></i>
                        <span class="ml-4 font-medium hidden lg:block">Trang ch·ªß</span>
                    </a>
                </li>
                <li>
                    <a href="#student-lessons" class="student-sidebar-link flex items-center justify-center lg:justify-start p-3 rounded-lg text-gray-500 hover:bg-yellow-50 hover:text-yellow-600" data-view="student-lessons">
                        <i class="fas fa-book fa-fw text-xl"></i>
                        <span class="ml-4 font-medium hidden lg:block">L·ªô tr√¨nh h·ªçc t·∫≠p</span>
                    </a>
                </li>
                <li> <!-- M·ªöI: Th√™m G√≥c Gi·∫£i Tr√≠ -->
                    <a href="#student-games" class="student-sidebar-link flex items-center justify-center lg:justify-start p-3 rounded-lg text-gray-500 hover:bg-yellow-50 hover:text-yellow-600" data-view="student-games">
                        <i class="fas fa-gamepad fa-fw text-xl"></i>
                        <span class="ml-4 font-medium hidden lg:block">G√≥c gi·∫£i tr√≠</span>
                    </a>
                </li>
                <li>
                    <a href="#student-achievements" class="student-sidebar-link flex items-center justify-center lg:justify-start p-3 rounded-lg text-gray-500 hover:bg-yellow-50 hover:text-yellow-600" data-view="student-achievements">
                        <i class="fas fa-trophy fa-fw text-xl"></i>
                        <span class="ml-4 font-medium hidden lg:block">Th√†nh t√≠ch</span>
                    </a>
                </li>
                <li>
                    <a href="#student-ai-tutor" class="student-sidebar-link flex items-center justify-center lg:justify-start p-3 rounded-lg text-gray-500 hover:bg-yellow-50 hover:text-yellow-600" data-view="student-ai-tutor">
                        <i class="fas fa-robot fa-fw text-xl"></i>
                        <span class="ml-4 font-medium hidden lg:block">Gia s∆∞ AI</span>
                    </a>
                </li>
            </ul>
             <div class="px-4 py-4">
                <a href="#logout" id="studentLogoutBtn" class="flex items-center justify-center lg:justify-start p-3 rounded-lg text-red-600 bg-red-50 hover:bg-red-100" data-view="logout">
                    <i class="fas fa-sign-out-alt fa-fw text-xl"></i>
                    <span class="ml-4 font-medium hidden lg:block">ƒêƒÉng xu·∫•t</span>
                </a>
            </div>
        </nav>

        <!-- Student Main Content -->
        <main class="flex-1 h-screen overflow-y-auto">
            <!-- Student Header -->
            <header class="h-20 bg-white shadow-sm flex items-center justify-between px-6">
                <h1 id="student-view-title" class="text-2xl font-bold text-gray-800">Trang ch·ªß c·ªßa t√¥i</h1>
                <div class="flex items-center space-x-4">
                    <button class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-bell text-xl"></i>
                    </button>
                    <div class="flex items-center">
                        <img src="https://placehold.co/40x40/f59e0b/white?text=S" alt="Student" class="w-10 h-10 rounded-full">
                        <span id="student-name-header" class="ml-3 font-medium text-gray-700 hidden md:block">[T√™n H·ªçc Sinh]</span>
                    </div>
                </div>
            </header>

            <!-- Student Page Content -->
            <div class="p-6 space-y-6">
                <!-- Student Dashboard View -->
                <div id="student-dashboard-view" class="student-view-content space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-md flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0">
                        <div>
                            <h2 id="student-welcome" class="text-2xl font-bold text-gray-800">Ch√†o m·ª´ng, [T√™n H·ªçc Sinh]!</h2>
                            <p class="text-gray-600">H√£y ti·∫øp t·ª•c h√†nh tr√¨nh h·ªçc t·∫≠p tuy·ªát v·ªùi c·ªßa b·∫°n.</p>
                        </div>
                        <div class="flex items-center space-x-6">
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-500">Kinh nghi·ªám (XP)</p>
                                <p id="student-xp" class="text-2xl font-bold text-indigo-600">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-500">Chu·ªói ng√†y</p>
                                <p id="student-streak" class="text-2xl font-bold text-yellow-600">üî• 0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-500">X·∫øp h·∫°ng</p>
                                <p id="student-rank" class="text-2xl font-bold text-green-600">#0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">Ti·∫øn ƒë·ªô nhanh</h3>
                        <p class="text-gray-600">B·∫Øt ƒë·∫ßu b√†i h·ªçc ti·∫øp theo c·ªßa b·∫°n ngay!</p>
                        <!-- Th√™m n·ªôi dung dashboard h·ªçc sinh ·ªü ƒë√¢y -->
                    </div>
                </div>
                
                <!-- Student Lessons View -->
                <div id="student-lessons-view" class="student-view-content hidden space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">L·ªô tr√¨nh h·ªçc t·∫≠p</h3>
                        <div id="student-lesson-list" class="space-y-4">
                            <!-- Student lessons will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- M·ªöI: Student Games View -->
                <div id="student-games-view" class="student-view-content hidden space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">G√≥c gi·∫£i tr√≠</h3>
                        <div id="student-game-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Danh s√°ch game s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
                        </div>
                    </div>
                </div>

                <!-- Student Achievements View -->
                <div id="student-achievements-view" class="student-view-content hidden space-y-6">
                    <!-- B·ªê C·ª§C M·ªöI: Chia 2 c·ªôt -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- C·ªôt 1: Huy hi·ªáu -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4 text-gray-700">Huy hi·ªáu c·ªßa t√¥i</h3>
                            <div id="student-achievements-list" class="flex flex-wrap gap-4">
                                <!-- Achievements will be injected here -->
                            </div>
                        </div>
                        <!-- C·ªôt 2: X·∫øp h·∫°ng -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 id="leaderboard-title" class="text-xl font-semibold mb-4 text-gray-700">X·∫øp h·∫°ng</h3>
                            <div id="student-leaderboard" class="space-y-3">
                                <!-- Leaderboard will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Student AI Tutor View -->
                <div id="student-ai-tutor-view" class="student-view-content hidden">
                    <div class="bg-white rounded-lg shadow-md max-w-3xl mx-auto h-[70vh] flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h2 class="text-xl font-semibold text-gray-700">Gia s∆∞ AI (H·ªçc sinh)</h2>
                            <div>
                                <label for="student-ai-grade" class="text-sm font-medium text-gray-700 mr-2">Em ƒëang h·ªçc:</label>
                                <select id="student-ai-grade" class="px-3 py-1 border border-gray-300 rounded-md shadow-sm">
                                    <option value="L·ªõp 6">L·ªõp 6</option>
                                    <option value="L·ªõp 7">L·ªõp 7</option>
                                    <option value="L·ªõp 8">L·ªõp 8</option>
                                    <option value="L·ªõp 9">L·ªõp 9</option>
                                </select>
                            </div>
                        </div>
                        <div id="student-ai-chat-box" class="flex-1 p-6 space-y-4 overflow-y-auto">
                            <!-- AI Welcome Message -->
                            <div class="flex justify-start">
                                <div class="p-3 rounded-lg bg-gray-100 text-gray-800 max-w-lg">
                                    <p>Xin ch√†o! T√¥i l√† Gia s∆∞ AI. B·∫°n mu·ªën h·ªèi v·ªÅ ch·ªß ƒë·ªÅ g√¨ h√¥m nay?</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border-t">
                            <form id="student-ai-chat-form" class="flex space-x-3">
                                <input type="text" id="student-ai-chat-input" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n...">
                                <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">G·ª≠i</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>


    <!-- Modals (Shared) -->

    <!-- Lesson Modal -->
    <div id="lessonModal" class="modal hidden-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b">
                <h2 class="text-xl font-semibold text-gray-800">T·∫°o/Ch·ªânh s·ª≠a B√†i h·ªçc</h2>
                <button id="closeLessonModalBtn" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <form id="lessonForm" class="space-y-4">
                    <div>
                        <label for="lessonTitle" class="block text-sm font-medium text-gray-700">Ti√™u ƒë·ªÅ</label>
                        <input type="text" id="lessonTitle" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                    <div>
                        <label for="lessonTopic" class="block text-sm font-medium text-gray-700">Ch·ªß ƒë·ªÅ</label>
                        <input type="text" id="lessonTopic" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <!-- M·ªöI: Th√™m √¥ ch·ªçn Kh·ªëi -->
                    <div>
                        <label for="lessonGrade" class="block text-sm font-medium text-gray-700">Kh·ªëi l·ªõp</label>
                        <select id="lessonGrade" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            <option value="">-- Ch·ªçn kh·ªëi --</option>
                            <option value="6">Kh·ªëi 6</option>
                            <option value="7">Kh·ªëi 7</option>
                            <option value="8">Kh·ªëi 8</option>
                            <option value="9">Kh·ªëi 9</option>
                        </select>
                    </div>
                    <div>
                        <label for="lessonContent" class="block text-sm font-medium text-gray-700">N·ªôi dung (HTML)</label>
                        <textarea id="lessonContent" rows="10" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm font-mono text-sm"></textarea>
                    </div>
                    <!-- N√∫t AI ƒë√£ b·ªã x√≥a -->
                </form>
            </div>
            <div class="p-5 border-t bg-gray-50 flex justify-end">
                <button id="saveLessonBtn" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">L∆∞u B√†i h·ªçc</button>
            </div>
        </div>
    </div>

    <!-- Exercise Modal -->
    <div id="exerciseModal" class="modal hidden-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b">
                <h2 class="text-xl font-semibold text-gray-800">T·∫°o B√†i t·∫≠p</h2>
                <button id="closeExerciseModalBtn" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- Exercise Tabs - M·ªöI: Th√™m l·∫°i tab T·∫£i file Word -->
                <div class="border-b border-gray-200 px-6">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button class="exercise-tab-button active tab-button whitespace-nowrap py-4 px-1 text-sm font-medium" data-tab="manual-exercise">
                            Nh·∫≠p th·ªß c√¥ng
                        </button>
                        <button class="exercise-tab-button tab-button whitespace-nowrap py-4 px-1 text-sm font-medium" data-tab="file-exercise">
                            T·∫£i file Word
                        </button>
                    </nav>
                </div>
                <!-- Tab Content -->
                <div class="flex-1 overflow-y-auto">
                    <div id="manual-exercise" class="exercise-tab-content p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Left: Form -->
                            <form id="manualExerciseForm" class="space-y-4">
                                <div>
                                    <label for="relatedLesson" class="block text-sm font-medium text-gray-700">B√†i h·ªçc li√™n quan</label>
                                    <select id="relatedLesson" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                                        <!-- Options will be populated by JS -->
                                    </select>
                                </div>
                                <div>
                                    <label for="questionText" class="block text-sm font-medium text-gray-700">C√¢u h·ªèi</label>
                                    <textarea id="questionText" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                                </div>
                                <div>
                                    <label for="questionType" class="block text-sm font-medium text-gray-700">Lo·∫°i c√¢u h·ªèi</label>
                                    <select id="questionType" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                        <option value="multiple-choice">Tr·∫Øc nghi·ªám (Nhi·ªÅu l·ª±a ch·ªçn)</option>
                                        <option value="true-false">ƒê√∫ng/Sai</option>
                                        <option value="short-answer">Tr·∫£ l·ªùi ng·∫Øn</option>
                                        <option value="essay">T·ª± lu·∫≠n</option>
                                    </select>
                                </div>
                                <div id="answerOptionsContainer" class="space-y-2">
                                    <!-- Options for multiple-choice / true-false -->
                                </div>
                                <div>
                                    <label for="correctAnswer" class="block text-sm font-medium text-gray-700">ƒê√°p √°n ƒë√∫ng</label>
                                    <input type="text" id="correctAnswer" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Nh·∫≠p ch√≠nh x√°c ƒë√°p √°n">
                                </div>
                                <button type="button" id="addQuestionBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg">Th√™m c√¢u h·ªèi v√†o danh s√°ch</button>
                            </form>
                            <!-- Right: Preview -->
                            <div class="bg-gray-50 p-4 rounded-lg border h-full">
                                <h3 class="font-semibold text-gray-700 mb-3">Xem tr∆∞·ªõc B√†i t·∫≠p</h3>
                                <div id="exercisePreviewList" class="space-y-3 overflow-y-auto max-h-96">
                                    <p class="text-sm text-gray-500">Ch∆∞a c√≥ c√¢u h·ªèi n√†o...</p>
                                    <!-- Preview items will be injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- M·ªöI: Th√™m l·∫°i n·ªôi dung tab T·∫£i file Word -->
                    <div id="file-exercise" class="exercise-tab-content p-6 hidden">
                        <!-- File input that is visually hidden -->
                        <input type="file" id="wordFileInput" class="hidden" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
                        
                        <!-- Updated file upload area -->
                        <div id="fileUploadArea" class="file-upload-area p-8 text-center rounded-lg cursor-pointer" onclick="document.getElementById('wordFileInput').click();">
                            <i class="fas fa-file-word text-blue-500 text-4xl mb-4"></i>
                            <h3 class="font-semibold text-lg">T·∫£i l√™n t·ªáp .docx</h3>
                            <p class="text-sm text-gray-600">K√©o v√† th·∫£ t·ªáp v√†o ƒë√¢y, ho·∫∑c nh·∫•p ƒë·ªÉ ch·ªçn t·ªáp.</p>
                        </div>
                        
                        <!-- Added sample format block -->
                        <div class="mt-6 p-4 bg-gray-100 rounded-lg text-left">
                            <h4 class="font-semibold text-gray-800 mb-2">ƒê·ªãnh d·∫°ng t·ªáp .docx m·∫´u:</h4>
                            <pre class="text-xs text-gray-700 bg-white p-3 rounded overflow-x-auto">
I. TR·∫ÆC NGHI·ªÜM
C√¢u 1: Th·ªß ƒë√¥ c·ªßa Vi·ªát Nam l√† g√¨?
A. H√† N·ªôi
B. TP. H·ªì Ch√≠ Minh
C. ƒê√† N·∫µng
D. H·∫£i Ph√≤ng

II. ƒê√öNG/SAI
C√¢u 3: M·∫∑t tr·ªùi m·ªçc ·ªü h∆∞·ªõng T√¢y.

III. TR·∫¢ L·ªúI NG·∫ÆN
C√¢u 5: Nguy√™n t·ªë h√≥a h·ªçc c·ªßa V√†ng l√† g√¨?

IV. T·ª∞ LU·∫¨N
C√¢u 6: Tr√¨nh b√†y suy nghƒ© c·ªßa em...

V. ƒê√ÅP √ÅN
1. A
3. Sai
5. Au
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-5 border-t bg-gray-50 flex justify-end">
                <button id="saveExerciseBtn" class="px-5 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700">L∆∞u B√†i t·∫≠p</button>
            </div>
        </div>
    </div>
    
    <!-- Game Modals -->
    <!-- Memory Game Modal -->
    <div id="memoryGameModal" class="modal hidden-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl">
            <div class="flex justify-between items-center p-5 border-b">
                <h2 class="text-xl font-semibold text-gray-800">T·∫°o Tr√≤ ch∆°i L·∫≠t th·∫ª</h2>
                <button id="closeMemoryGameModalBtn" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <form id="memoryGameForm" class="space-y-4">
                    <div>
                        <label for="memoryGameTitle" class="block text-sm font-medium text-gray-700">Ti√™u ƒë·ªÅ Tr√≤ ch∆°i</label>
                        <input type="text" id="memoryGameTitle" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="V√≠ d·ª•: T·ª´ v·ª±ng Ti·∫øng Anh Unit 1" required>
                    </div>
                    <div>
                        <label for="gamePairs" class="block text-sm font-medium text-gray-700">Nh·∫≠p c√°c c·∫∑p (v√≠ d·ª•: M√®o:Cat, Ch√≥:Dog)</label>
                        <textarea id="gamePairs" rows="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="M√®o:Cat&#10;Ch√≥:Dog&#10;N∆∞·ªõc:Water" required></textarea>
                    </div>
                </form>
                <div id="memory-game-board" class="mt-6 grid grid-cols-4 gap-4 justify-center">
                    <!-- Game cards will be injected here -->
                </div>
            </div>
            <div class="p-5 border-t bg-gray-50 flex justify-end">
                <button id="saveMemoryGameBtn" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">L∆∞u Tr√≤ ch∆°i</button>
            </div>
        </div>
    </div>

    <!-- Custom Game Modal -->
    <div id="customGameModal" class="modal hidden-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b">
                <h2 class="text-xl font-semibold text-gray-800">T·∫°o Tr√≤ ch∆°i T√πy ch·ªânh</h2>
                <button id="closeCustomGameModalBtn" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-px bg-gray-200 overflow-hidden">
                <!-- Editor -->
                <div class="flex flex-col bg-white overflow-hidden">
                    <form id="customGameForm" class="flex-1 flex flex-col p-4 space-y-4">
                        <div>
                            <label for="gameTitle" class="block text-sm font-medium text-gray-700">Ti√™u ƒë·ªÅ Tr√≤ ch∆°i</label>
                            <input type="text" id="gameTitle" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <label for="gameHtml" class="block text-sm font-medium text-gray-700">HTML</label>
                            <textarea id="gameHtml" rows="8" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm font-mono text-sm" placeholder="<div id='my-game'></div>"></textarea>
                        </div>
                        <div>
                            <label for="gameCss" class="block text-sm font-medium text-gray-700">CSS</label>
                            <textarea id="gameCss" rows="8" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm font-mono text-sm" placeholder="#my-game { background: blue; }"></textarea>
                        </div>
                        <div>
                            <label for="gameJs" class="block text-sm font-medium text-gray-700">JavaScript</label>
                            <textarea id="gameJs" rows="8" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm font-mono text-sm" placeholder="console.log('Game started!')"></textarea>
                        </div>
                    </form>
                    <div class="p-4 border-t flex space-x-4">
                         <button id="previewCustomGameBtn" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg">Xem tr∆∞·ªõc</button>
                         <button id="saveCustomGameBtn" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg">L∆∞u Tr√≤ ch∆°i</button>
                    </div>
                </div>
                <!-- Preview -->
                <div class="bg-white overflow-auto">
                    <iframe id="gamePreviewFrame" class="w-full h-full border-0"></iframe>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Student Lesson Modal -->
    <div id="studentLessonModal" class="modal hidden-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b">
                <h2 id="studentLessonTitle" class="text-xl font-semibold text-gray-800">Ti√™u ƒë·ªÅ B√†i h·ªçc</h2>
                <button id="closeStudentLessonModalBtn" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div id="studentLessonContent" class="p-6 prose max-w-none overflow-y-auto">
                <!-- Lesson content injected here -->
            </div>
            <div class="p-5 border-t bg-gray-50 flex justify-end">
                <button id="completeLessonBtn" class="px-5 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">ƒê√£ hi·ªÉu</button>
            </div>
        </div>
    </div>

    <!-- M·ªöI: Student Exercise Modal (Giao di·ªán l√†m b√†i) -->
    <div id="studentExerciseModal" class="modal hidden-modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center p-5 border-b">
                <h2 id="studentExerciseTitle" class="text-xl font-semibold text-gray-800">L√†m b√†i t·∫≠p</h2>
                <button id="closeStudentExerciseModalBtn" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            
            <!-- Content: N·ªôi dung c√¢u h·ªèi -->
            <div id="studentExerciseContent" class="p-6 flex-1 overflow-y-auto">
                <!-- Thanh ti·∫øn tr√¨nh -->
                <div class="flex justify-between items-center mb-4">
                    <p id="exerciseProgress" class="text-sm font-medium text-gray-600">C√¢u 1 / 10</p>
                    <div class="w-3/4 bg-gray-200 rounded-full h-2.5">
                        <div id="exerciseProgressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 10%"></div>
                    </div>
                </div>
                
                <!-- Khu v·ª±c c√¢u h·ªèi -->
                <div id="currentQuestionContainer" class="exercise-container space-y-4">
                    <h3 id="questionText" class="text-lg font-semibold text-gray-900 bg-yellow-50 p-4 rounded-lg shadow-sm">N·ªôi dung c√¢u h·ªèi s·∫Ω ·ªü ƒë√¢y?</h3>
                    
                    <!-- Khu v·ª±c ƒë√°p √°n (dynamic) -->
                    <div id="answerOptions" class="space-y-3">
                        <!-- C√°c l·ª±a ch·ªçn s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
                    </div>
                    
                    <!-- Khu v·ª±c input cho tr·∫£ l·ªùi ng·∫Øn -->
                    <div id="shortAnswerContainer" class="hidden">
                        <input type="text" id="shortAnswerInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n...">
                    </div>
                    
                    <!-- Khu v·ª±c input cho t·ª± lu·∫≠n -->
                    <div id="essayContainer" class="hidden">
                        <textarea id="essayInput" rows="5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..."></textarea>
                    </div>

                    <!-- Ph·∫£n h·ªìi ƒê√∫ng/Sai -->
                    <div id="questionFeedback" class="mt-4 p-4 rounded-md hidden">
                        <!-- N·ªôi dung ph·∫£n h·ªìi -->
                    </div>
                </div>
            </div>
            
            <!-- Footer: N√∫t ƒëi·ªÅu h∆∞·ªõng -->
            <div class="p-5 border-t bg-gray-50 flex justify-between items-center">
                <button id="prevQuestionBtn" class="px-5 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400">
                    <i class="fas fa-arrow-left mr-2"></i>C√¢u tr∆∞·ªõc
                </button>
                <button id="checkAnswerBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                    <i class="fas fa-check mr-2"></i>Ki·ªÉm tra
                </button>
                <button id="nextQuestionBtn" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">
                    C√¢u ti·∫øp<i class="fas fa-arrow-right ml-2"></i>
                </button>
                <button id="finishQuizBtn" class="px-5 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 hidden">
                    <i class="fas fa-flag-checkered mr-2"></i>Ho√†n th√†nh
                </button>
            </div>
        </div>
    </div>
    
    <!-- M·ªöI: Modal Ch∆°i Game -->
    <div id="gamePlayModal" class="modal hidden-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b">
                <h2 id="gamePlayTitle" class="text-xl font-semibold text-gray-800">ƒêang ch∆°i...</h2>
                <button id="closeGamePlayModalBtn" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div id="gamePlayContent" class="p-6 flex-1 overflow-auto">
                <!-- Iframe cho game t√πy ch·ªânh -->
                <iframe id="gamePlayFrame" class="w-full h-full min-h-[60vh] border-0 hidden"></iframe>
                <!-- Board cho memory game -->
                <div id="gamePlayMemoryBoard" class="mt-6 grid grid-cols-4 gap-4 justify-center hidden">
                    <!-- Memory cards will be injected here -->
                </div>
            </div>
        </div>
    </div>


    <!-- Notification Container -->
    <div id="notification"></div>

    <script>
        // --- API KEYS (Placeholder) ---
        const GEMINI_API_KEY = ""; // ƒê·ªÉ tr·ªëng, Canvas s·∫Ω t·ª± ƒëi·ªÅn
        
        // M·ªöI: URL c·ªßa Google Apps Script
        // !!! QUAN TR·ªåNG: B·∫°n c·∫ßn thay th·∫ø b·∫±ng URL c·ªßa B·∫†N sau khi tri·ªÉn khai GAS
        const GAS_WEB_APP_URL = "D√ÅN_URL_GOOGLE_APPS_SCRIPT_CUA_BAN_VAO_DAY";


        // --- D·ªÆ LI·ªÜU TO√ÄN C·ª§C (S·∫Ω ƒë∆∞·ª£c t·∫£i t·ª´ GAS) ---
        let allStudents = [];
        let allLessons = [];
        let allExercises = [];
        let allGames = []; // M·ªöI
        
        let exerciseQuestions = []; // Temporary store for questions being added
        let currentEditingLessonId = null; 
        
        // State cho vi·ªác l√†m b√†i t·∫≠p
        let currentQuiz = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let currentQuizLessonId = null;
        
        // D·ªØ li·ªáu c·ªßa h·ªçc sinh hi·ªán t·∫°i (s·∫Ω ƒë∆∞·ª£c set khi ƒëƒÉng nh·∫≠p)
        let currentStudent = null;
        
        // D·ªØ li·ªáu tƒ©nh (kh√¥ng c·∫ßn t·∫£i t·ª´ GAS)
        const allAchievements = [
            { id: "start", icon: "fa-rocket", title: "Kh·ªüi ƒë·∫ßu", xp: 0 },
            { id: "xp100", icon: "fa-seedling", title: "100 XP", xp: 100 },
            { id: "xp500", icon: "fa-bolt", title: "500 XP", xp: 500 },
            { id: "xp1000", icon: "fa-star", title: "1000 XP", xp: 1000 },
            { id: "streak3", icon: "fa-fire", title: "Chu·ªói 3 ng√†y", xp: 0 },
            { id: "first10", icon: "fa-medal", title: "Ho√†n th√†nh 10 b√†i", xp: 0 }
        ];
        
        let activityChartInstance = null; // To hold the chart object

        // --- API CALLS (Gemini & Google Sheets) ---

        // M·ªöI: H√†m fetch chung g·ªçi ƒë·∫øn GAS
        async function fetchGas(action, payload = {}, method = "POST") { // M·∫∑c ƒë·ªãnh l√† POST
          let url = GAS_WEB_APP_URL;
          
          // D√πng GET cho 'loadAll'
          if (action === "loadAll" && method === "GET") {
              url += `?action=loadAll`;
          }

          const options = {
            method: method,
            redirect: "follow",
            headers: {},
            body: null
          };

          if (method === "POST") {
            options.body = JSON.stringify({ action: action, payload: payload });
            options.headers["Content-Type"] = "text/plain;charset=utf-8"; // GAS Web App th∆∞·ªùng d√πng text/plain
          }

          try {
            const response = await fetch(url, options);
            if (!response.ok) {
              throw new Error(`L·ªói m·∫°ng khi g·ªçi GAS: ${response.statusText}`);
            }
            const result = await response.json();
            if (result.status === "error") {
              throw new Error(`L·ªói t·ª´ GAS: ${result.message}`);
            }
            return result.data || result; // Tr·∫£ v·ªÅ data n·∫øu c√≥
          } catch (error) {
            console.error(`L·ªói khi th·ª±c hi·ªán h√†nh ƒë·ªông '${action}':`, error);
            showNotification(`L·ªói: ${error.message}`, "error");
            throw error; // N√©m l·ªói ra ƒë·ªÉ h√†m g·ªçi c√≥ th·ªÉ x·ª≠ l√Ω
          }
        }

        async function callGemini(prompt, systemInstruction = null) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            
            if (systemInstruction) {
                payload.systemInstruction = {
                    parts: [{ text: systemInstruction }]
                };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API Error:", errorBody);
                    throw new Error(`API Error: ${response.statusText}`);
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) {
                    throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi h·ª£p l·ªá t·ª´ AI.");
                }
                return text;
            } catch (error) {
                console.error("L·ªói g·ªçi Gemini:", error);
                throw error;
            }
        }
        
        // --- NOTIFICATION ---
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = type; // Th√™m class (success, error, ...)
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // --- INIT & ROUTING (NEW) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Admin login
            const loginAdminBtn = document.getElementById('loginAsAdminBtn');
            if (loginAdminBtn) {
                loginAdminBtn.addEventListener('click', showAdminPortal);
            }
            
            // Student login (form)
            const loginStudentForm = document.getElementById('student-login-form');
            if (loginStudentForm) {
                loginStudentForm.addEventListener('submit', loginAsStudent);
            }
            
            // Add logout listeners
            const logoutAdminBtn = document.getElementById('adminLogoutBtn');
            if (logoutAdminBtn) {
                logoutAdminBtn.addEventListener('click', showLoginView);
            }
            
            const logoutStudentBtn = document.getElementById('studentLogoutBtn');
            if (logoutStudentBtn) {
                logoutStudentBtn.addEventListener('click', showLoginView);
            }

            // Add all other shared listeners
            setupSharedListeners();
        });
        
        // M·ªöI: T·∫£i t·∫•t c·∫£ d·ªØ li·ªáu t·ª´ Google Sheet
        async function loadAllData() {
            showNotification("ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheet...", "info");
            try {
                const data = await fetchGas("loadAll", {}, "GET"); // D√πng GET cho loadAll
                allStudents = data.students || [];
                allLessons = data.lessons || [];
                allExercises = data.exercises || [];
                allGames = data.games || []; // M·ªöI
                showNotification("T·∫£i d·ªØ li·ªáu th√†nh c√¥ng!", "success");
            } catch (error) {
                showNotification("L·ªói nghi√™m tr·ªçng: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra URL c·ªßa GAS.", "error");
                // Gi·ªØ trang ·ªü login
                showLoginView();
            }
        }
        
        async function loginAsStudent(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            if (!username) {
                showNotification("Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p", "warning");
                return;
            }
            
            const loadingText = document.getElementById('student-login-loading');
            loadingText.classList.remove('hidden');
            
            // T·∫£i d·ªØ li·ªáu M·ªñI KHI ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫£m b·∫£o l√† m·ªõi nh·∫•t
            await loadAllData();
            
            loadingText.classList.add('hidden');
            
            const student = allStudents.find(s => s.username.toLowerCase() === username.toLowerCase());
            
            if (student) {
                currentStudent = student; // Set the global current student
                showStudentPortal();
                document.getElementById('username').value = ''; // Clear input on success
            } else {
                showNotification("T√™n ƒëƒÉng nh·∫≠p kh√¥ng ƒë√∫ng!", "error");
                currentStudent = null;
            }
        }
        
        function showLoginView() {
            const loginView = document.getElementById('login-view');
            const adminPortal = document.getElementById('admin-portal');
            const studentPortal = document.getElementById('student-portal');

            if (loginView) loginView.classList.remove('hidden');
            if (adminPortal) adminPortal.classList.add('hidden');
            if (studentPortal) studentPortal.classList.add('hidden');
            
            currentStudent = null; // ƒê·∫£m b·∫£o clear h·ªçc sinh khi logout
        }
        
        async function showAdminPortal() {
            const loginView = document.getElementById('login-view');
            const adminPortal = document.getElementById('admin-portal');
            const studentPortal = document.getElementById('student-portal');

            if (loginView) loginView.classList.add('hidden');
            if (adminPortal) adminPortal.classList.remove('hidden');
            if (studentPortal) studentPortal.classList.add('hidden');
            
            // T·∫£i d·ªØ li·ªáu khi v√†o trang Admin
            await loadAllData();
            
            // Initialize admin-specific content
            initAdminPortal();
        }
        
        function showStudentPortal() {
            if (!currentStudent) {
                showLoginView();
                showNotification("Vui l√≤ng ƒëƒÉng nh·∫≠p", "warning");
                return;
            }
            const loginView = document.getElementById('login-view');
            const adminPortal = document.getElementById('admin-portal');
            const studentPortal = document.getElementById('student-portal');

            if (loginView) loginView.classList.add('hidden');
            if (adminPortal) adminPortal.classList.add('hidden');
            if (studentPortal) studentPortal.classList.remove('hidden');
            
            // Initialize student-specific content
            initStudentPortal();
        }

        function initAdminPortal() {
            renderDashboard();
            renderStudents();
            renderLessons(); // This also populates exercise dropdowns
            renderExercises();
            renderAdminLeaderboard('all'); // M·ªöI: Render b·∫£ng x·∫øp h·∫°ng admin
            
            // Setup Admin Sidebar Listeners
            document.querySelectorAll('.admin-sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = link.getAttribute('data-view');
                    
                    document.querySelectorAll('.admin-view-content').forEach(v => v.classList.add('hidden'));
                    const viewEl = document.getElementById(`${view}-view`);
                    if (viewEl) viewEl.classList.remove('hidden');
                    
                    const titleMap = {
                        'dashboard': 'B·∫£ng ƒëi·ªÅu khi·ªÉn',
                        'students': 'Qu·∫£n l√Ω H·ªçc sinh',
                        'lessons': 'Qu·∫£n l√Ω B√†i h·ªçc',
                        'exercises': 'Qu·∫£n l√Ω B√†i t·∫≠p',
                        'games': 'T·∫°o Tr√≤ ch∆°i',
                        'sheets': 'T√≠ch h·ª£p Google Sheets',
                        'ai-tutor': 'Gia s∆∞ AI',
                        'leaderboard': 'B·∫£ng x·∫øp h·∫°ng' // M·ªöI
                    };
                    document.getElementById('admin-view-title').textContent = titleMap[view] || 'B·∫£ng ƒëi·ªÅu khi·ªÉn';
                    
                    document.querySelectorAll('.admin-sidebar-link').forEach(l => l.classList.remove('active', 'bg-indigo-50', 'text-indigo-600'));
                    link.classList.add('active', 'bg-indigo-50', 'text-indigo-600');
                    
                    // M·ªöI: C·∫≠p nh·∫≠t l·∫°i X·∫øp h·∫°ng khi chuy·ªÉn tab (ph√≤ng tr∆∞·ªùng h·ª£p data ƒë·ªïi)
                    if(view === 'leaderboard') {
                        renderAdminLeaderboard();
                    }
                });
            });

            // M·ªöI: Th√™m listeners cho filter b·∫£ng x·∫øp h·∫°ng admin
            document.querySelectorAll('.admin-lb-filter').forEach(button => {
                button.addEventListener('click', () => {
                    const grade = button.dataset.grade;
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i active
                    document.querySelectorAll('.admin-lb-filter').forEach(btn => {
                        btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    button.classList.add('active', 'bg-indigo-600', 'text-white');
                    button.classList.remove('bg-gray-200', 'text-gray-700');
                    
                    renderAdminLeaderboard(grade);
                });
            });
        }
        
        function initStudentPortal() {
            if (!currentStudent) return;

            // T·ª± ƒë·ªông set kh·ªëi l·ªõp cho Gia s∆∞ AI
            const grade = currentStudent.class.charAt(0); // "6", "7", etc.
            document.getElementById('student-ai-grade').value = `L·ªõp ${grade}`;

            updateStudentView(); // This also renders lessons and achievements for student
            
            // Setup Student Sidebar Listeners
            document.querySelectorAll('.student-sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = link.getAttribute('data-view'); // e.g., "student-dashboard"
                    
                    document.querySelectorAll('.student-view-content').forEach(v => v.classList.add('hidden'));
                    const viewEl = document.getElementById(`${view}-view`);
                    if(viewEl) viewEl.classList.remove('hidden');
                    
                    const titleMap = {
                        'student-dashboard': 'Trang ch·ªß c·ªßa t√¥i',
                        'student-lessons': 'L·ªô tr√¨nh h·ªçc t·∫≠p',
                        'student-games': 'G√≥c gi·∫£i tr√≠', // M·ªöI
                        'student-achievements': 'Th√†nh t√≠ch',
                        'student-ai-tutor': 'Gia s∆∞ AI'
                    };
                    document.getElementById('student-view-title').textContent = titleMap[view] || 'Trang ch·ªß';
                    
                    document.querySelectorAll('.student-sidebar-link').forEach(l => l.classList.remove('active', 'bg-yellow-50', 'text-yellow-600'));
                    link.classList.add('active', 'bg-yellow-50', 'text-yellow-600');
                    
                    // C·∫≠p nh·∫≠t l·∫°i X·∫øp h·∫°ng khi chuy·ªÉn tab
                    if(view === 'student-achievements') {
                        renderLeaderboard();
                    }
                    // M·ªöI: Render game khi chuy·ªÉn tab
                    if (view === 'student-games') {
                        renderStudentGames();
                    }
                });
            });
            
            // Set default active link for student
            const defaultLink = document.querySelector('.student-sidebar-link[data-view="student-dashboard"]');
            if (defaultLink) {
                defaultLink.classList.add('active', 'bg-yellow-50', 'text-yellow-600');
            }
        }

        // S·ª¨A L·ªñI: Th√™m ki·ªÉm tra an to√†n (null checks) cho c√°c h√†m setup
        function setupSharedListeners() {
            // --- Modal Listeners ---
            const openLessonModalBtn = document.getElementById('openLessonModalBtn');
            if (openLessonModalBtn) openLessonModalBtn.addEventListener('click', handleCreateLessonClick);
            
            const closeLessonModalBtn = document.getElementById('closeLessonModalBtn');
            if (closeLessonModalBtn) closeLessonModalBtn.addEventListener('click', () => closeModal('lessonModal'));
            
            const openExerciseModalBtn = document.getElementById('openExerciseModalBtn');
            if (openExerciseModalBtn) openExerciseModalBtn.addEventListener('click', () => openExerciseModal(null));
            
            const closeExerciseModalBtn = document.getElementById('closeExerciseModalBtn');
            if (closeExerciseModalBtn) closeExerciseModalBtn.addEventListener('click', () => closeModal('exerciseModal'));
            
            const closeMemoryGameModalBtn = document.getElementById('closeMemoryGameModalBtn');
            if (closeMemoryGameModalBtn) closeMemoryGameModalBtn.addEventListener('click', () => closeModal('memoryGameModal'));
            
            const closeCustomGameModalBtn = document.getElementById('closeCustomGameModalBtn');
            if (closeCustomGameModalBtn) closeCustomGameModalBtn.addEventListener('click', () => closeModal('customGameModal'));
            
            const closeStudentLessonModalBtn = document.getElementById('closeStudentLessonModalBtn');
            if (closeStudentLessonModalBtn) closeStudentLessonModalBtn.addEventListener('click', () => closeModal('studentLessonModal'));
            
            const closeStudentExerciseModalBtn = document.getElementById('closeStudentExerciseModalBtn');
            if (closeStudentExerciseModalBtn) closeStudentExerciseModalBtn.addEventListener('click', () => closeModal('studentExerciseModal'));
            
            // M·ªöI: Listener cho modal ch∆°i game
            const closeGamePlayModalBtn = document.getElementById('closeGamePlayModalBtn');
            if (closeGamePlayModalBtn) closeGamePlayModalBtn.addEventListener('click', () => {
                closeModal('gamePlayModal');
                // D·ª´ng game trong iframe
                document.getElementById('gamePlayFrame').src = 'about:blank';
            });
            
            // --- Form Listeners ---
            const lessonForm = document.getElementById('lessonForm');
            if (lessonForm) lessonForm.addEventListener('submit', (e) => e.preventDefault());
            
            const saveLessonBtn = document.getElementById('saveLessonBtn');
            if (saveLessonBtn) saveLessonBtn.addEventListener('click', saveLesson);
            
            const questionType = document.getElementById('questionType');
            if (questionType) questionType.addEventListener('change', updateAnswerOptions);
            
            const addQuestionBtn = document.getElementById('addQuestionBtn');
            if (addQuestionBtn) addQuestionBtn.addEventListener('click', addQuestion);
            
            const manualExerciseForm = document.getElementById('manualExerciseForm');
            if (manualExerciseForm) manualExerciseForm.addEventListener('submit', (e) => e.preventDefault());
            
            const saveExerciseBtn = document.getElementById('saveExerciseBtn');
            if (saveExerciseBtn) saveExerciseBtn.addEventListener('click', saveExercise);
            
            // --- File Upload Listeners ---
            const fileInput = document.getElementById('wordFileInput');
            const fileUploadArea = document.getElementById('fileUploadArea');
            if (fileInput && fileUploadArea) {
                fileInput.addEventListener('change', handleFileSelect);
                fileUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.add('dragover');
                });
                fileUploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.remove('dragover');
                });
                fileUploadArea.addEventListener('drop', handleFileDrop);
            }
            
            // --- Game Listeners ---
            const previewCustomGameBtn = document.getElementById('previewCustomGameBtn');
            if (previewCustomGameBtn) previewCustomGameBtn.addEventListener('click', previewCustomGame);
            
            const customGameForm = document.getElementById('customGameForm');
            if (customGameForm) customGameForm.addEventListener('submit', (e) => e.preventDefault());
            
            const saveCustomGameBtn = document.getElementById('saveCustomGameBtn');
            if (saveCustomGameBtn) saveCustomGameBtn.addEventListener('click', saveCustomGame); // M·ªöI: T√°ch h√†m
            
            const saveMemoryGameBtn = document.getElementById('saveMemoryGameBtn'); // M·ªöI: Listener
            if (saveMemoryGameBtn) saveMemoryGameBtn.addEventListener('click', saveMemoryGame);
            
            const createMemoryGameBtn = document.getElementById('createMemoryGameBtn');
            if (createMemoryGameBtn) createMemoryGameBtn.addEventListener('click', () => openModal('memoryGameModal')); // S·ª≠a: Ch·ªâ m·ªü modal
            
            const createCustomGameBtn = document.getElementById('createCustomGameBtn');
            if (createCustomGameBtn) createCustomGameBtn.addEventListener('click', () => openModal('customGameModal'));
            
            // --- AI Tutor Listeners ---
            const aiChatForm = document.getElementById('ai-chat-form');
            if (aiChatForm) aiChatForm.addEventListener('submit', handleAIChatSubmit);
            
            const studentAiChatForm = document.getElementById('student-ai-chat-form');
            if (studentAiChatForm) studentAiChatForm.addEventListener('submit', handleStudentAIChatSubmit);

            // --- Student View Listeners ---
            const completeLessonBtn = document.getElementById('completeLessonBtn');
            if (completeLessonBtn) completeLessonBtn.addEventListener('click', completeStudentLesson);
            
            // --- Listeners cho Giao di·ªán L√†m b√†i ---
            const prevQuestionBtn = document.getElementById('prevQuestionBtn');
            if (prevQuestionBtn) prevQuestionBtn.addEventListener('click', prevQuestion);
            
            const nextQuestionBtn = document.getElementById('nextQuestionBtn');
            if (nextQuestionBtn) nextQuestionBtn.addEventListener('click', nextQuestion);
            
            const checkAnswerBtn = document.getElementById('checkAnswerBtn');
            if (checkAnswerBtn) checkAnswerBtn.addEventListener('click', checkCurrentAnswer);
            
            const finishQuizBtn = document.getElementById('finishQuizBtn');
            if (finishQuizBtn) finishQuizBtn.addEventListener('click', finishQuiz);

            // --- Exercise Tabs Listener ---
            document.querySelectorAll('.exercise-tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    const tabContainer = button.closest('.border-b');
                    if (tabContainer) {
                        switchTab(tabId, '.exercise-tab-button', '.exercise-tab-content', tabContainer);
                    }
                });
            });
            
            // --- Init Call ---
            updateAnswerOptions(); // Initial call for exercise form
        }
        
        function handleCreateLessonClick() {
            currentEditingLessonId = null; // Chuy·ªÉn sang ch·∫ø ƒë·ªô t·∫°o m·ªõi
            document.getElementById('lessonForm').reset(); // X√≥a tr·∫Øng form
            document.getElementById('lessonGrade').value = ""; // ƒê·∫£m b·∫£o dropdown reset
            openModal('lessonModal');
        }
        
        // --- MODAL & TAB ---
        function openModal(modalId) {
            document.getElementById(modalId)?.classList.replace('hidden-modal', 'visible-modal');
        }
        function closeModal(modalId) {
            document.getElementById(modalId)?.classList.replace('visible-modal', 'hidden-modal');
        }
        function switchTab(tabId, buttonClass, contentClass, tabContainer) {
            // Hide all content
            const contentContainer = tabContainer.closest('.flex-1');
            if (contentContainer) {
                contentContainer.querySelectorAll(contentClass).forEach(content => {
                    content.classList.add('hidden');
                });
            }
            // Deactivate all buttons
            tabContainer.querySelectorAll(buttonClass).forEach(button => {
                button.classList.remove('active', 'text-indigo-600', 'border-indigo-600');
                button.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });
            // Show selected content
            document.getElementById(tabId).classList.remove('hidden');
            // Activate selected button
            const activeButton = tabContainer.querySelector(`[data-tab='${tabId}']`);
            if (activeButton) {
                activeButton.classList.add('active', 'text-indigo-600', 'border-indigo-600');
                activeButton.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            }
        }
        
        // --- DASHBOARD ---
        function renderDashboard() {
            document.getElementById('total-students').textContent = allStudents.length;
            document.getElementById('total-lessons').textContent = allLessons.length;
            document.getElementById('total-exercises').textContent = allExercises.length; // M·ªöI
            document.getElementById('total-games').textContent = allGames.length; // M·ªöI
            
            const ctx = document.getElementById('activityChart').getContext('2d');
            if (!ctx) return;
            
            // H·ªßy chart c≈© n·∫øu ƒë√£ t·ªìn t·∫°i (ƒë·ªÉ tr√°nh l·ªói khi ƒëƒÉng nh·∫≠p l·∫°i)
            if (activityChartInstance) {
                activityChartInstance.destroy();
            }
            
            activityChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'],
                    datasets: [{
                        label: 'B√†i h·ªçc ho√†n th√†nh',
                        data: [12, 19, 3, 17, 28, 24, 7],
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
        }
        
        // --- STUDENTS ---
        function renderStudents() {
            const list = document.getElementById('student-list');
            if (!list) return; // Ki·ªÉm tra an to√†n
            
            list.innerHTML = ''; // Clear list
            if (allStudents.length === 0) {
                list.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-gray-500">Ch∆∞a c√≥ h·ªçc sinh n√†o.</td></tr>';
                return;
            }
            allStudents.forEach(student => {
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50";
                row.innerHTML = `
                    <td class="p-3 text-sm text-gray-700">${student.name}</td>
                    <td class="p-3 text-sm text-gray-700">${student.username}</td>
                    <td class="p-3 text-sm text-gray-700">${student.class}</td>
                    <td class="p-3 text-sm text-gray-700">${student.xp}</td>
                    <td class="p-3 text-sm text-gray-700">
                        <button class="text-indigo-600 hover:text-indigo-800">Chi ti·∫øt</button>
                    </td>
                `;
                list.appendChild(row);
            });
        }
        
        // --- LESSONS (SHARED) ---
        function renderLessons() {
            // Admin list
            const adminList = document.getElementById('lesson-list');
            // Admin selects
            const relatedLessonSelect = document.getElementById('relatedLesson');
            // Student list
            const studentLessonList = document.getElementById('student-lesson-list');
            
            // Ki·ªÉm tra an to√†n
            if (!adminList || !relatedLessonSelect) return;
            
            // Clear all
            adminList.innerHTML = '';
            relatedLessonSelect.innerHTML = '<option value="">-- Ch·ªçn b√†i h·ªçc --</option>';
            if (studentLessonList) studentLessonList.innerHTML = '';
            
            if (allLessons.length === 0) {
                const emptyMsg = '<tr><td colspan="4" class="p-3 text-center text-gray-500">Ch∆∞a c√≥ b√†i h·ªçc n√†o.</td></tr>'; // C·∫≠p nh·∫≠t colspan
                adminList.innerHTML = emptyMsg;
                if (studentLessonList) studentLessonList.innerHTML = `<p class="text-center text-gray-500">Ch∆∞a c√≥ b√†i h·ªçc n√†o.</p>`;
                return;
            }
            
            // Log code h·ªçc sinh (n·∫øu c√≥) ƒë·ªÉ l·ªçc
            const studentGrade = currentStudent ? parseInt(currentStudent.class.charAt(0)) : null;
            let hasStudentLessons = false; // C·ªù ƒë·ªÉ ki·ªÉm tra xem h·ªçc sinh c√≥ b√†i h·ªçc n√†o kh√¥ng
            
            allLessons.forEach(lesson => {
                // Admin List
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50";
                row.innerHTML = `
                    <td class="p-3 text-sm text-gray-700">${lesson.title}</td>
                    <td class="p-3 text-sm text-gray-700">${lesson.topic}</td>
                    <td class="p-3 text-sm text-gray-700">${lesson.grade}</td> <!-- C·ªôt kh·ªëi m·ªõi -->
                    <td class="p-3 text-sm text-gray-700">
                        <button class="text-indigo-600 hover:text-indigo-800" onclick="editLesson(${lesson.id})">S·ª≠a</button>
                        <button class="text-red-600 hover:text-red-800 ml-3" onclick="deleteLesson(${lesson.id})">X√≥a</button>
                    </td>
                `;
                adminList.appendChild(row);
                
                // Exercise Modal Selects
                const option = document.createElement('option');
                option.value = lesson.id;
                option.textContent = `[Kh·ªëi ${lesson.grade}] ${lesson.title}`;
                relatedLessonSelect.appendChild(option.cloneNode(true));
                
                // Student View List (Ch·ªâ render n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p V√Ä ƒê√öNG KH·ªêI)
                if (currentStudent && studentLessonList) {
                    // **L·ªåC THEO KH·ªêI**
                    if (lesson.grade === studentGrade) {
                        hasStudentLessons = true;
                        const isCompleted = currentStudent.completedLessons.includes(lesson.id);
                        const studentLessonItem = document.createElement('div');
                        studentLessonItem.className = `p-4 border rounded-lg flex justify-between items-center ${isCompleted ? 'bg-green-50 border-green-200' : 'bg-white'}`;
                        studentLessonItem.innerHTML = `
                            <div>
                                <h4 class="font-semibold text-lg ${isCompleted ? 'text-green-800' : 'text-gray-800'}">${lesson.title}</h4>
                                <p class="text-sm ${isCompleted ? 'text-green-700' : 'text-gray-600'}">${lesson.topic}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="px-4 py-2 text-sm font-medium bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200" onclick="viewStudentLesson(${lesson.id})">
                                    <i class="fas fa-eye mr-1"></i> ƒê·ªçc n·ªôi dung
                                </button>
                                <button class="px-4 py-2 text-sm font-medium bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200" onclick="doStudentExercise(${lesson.id})">
                                    <i class="fas fa-pencil-alt mr-1"></i> L√†m b√†i
                                </button>
                            </div>
                        `;
                        studentLessonList.appendChild(studentLessonItem);
                    }
                }
            });
            
            // X·ª≠ l√Ω n·∫øu h·ªçc sinh kh√¥ng c√≥ b√†i h·ªçc n√†o thu·ªôc kh·ªëi c·ªßa m√¨nh
            if (currentStudent && studentLessonList && !hasStudentLessons) {
                studentLessonList.innerHTML = `<p class="text-center text-gray-500">Ch∆∞a c√≥ b√†i h·ªçc n√†o ƒë∆∞·ª£c g√°n cho Kh·ªëi ${studentGrade}.</p>`;
            }
        }
        
        async function saveLesson() {
            const title = document.getElementById('lessonTitle').value;
            const topic = document.getElementById('lessonTopic').value;
            const grade = document.getElementById('lessonGrade').value; // L·∫•y kh·ªëi
            const content = document.getElementById('lessonContent').value;
            
            if (!title) {
                showNotification("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ b√†i h·ªçc.", "warning");
                return;
            }
            if (!grade) { // Ki·ªÉm tra kh·ªëi
                showNotification("Vui l√≤ng ch·ªçn kh·ªëi l·ªõp.", "warning");
                return;
            }
            
            const newId = currentEditingLessonId || new Date().getTime();
            const payload = {
                id: newId,
                title: title,
                topic: topic,
                grade: parseInt(grade),
                content: content
            };
            
            showNotification("ƒêang l∆∞u b√†i h·ªçc...", "info");
            
            try {
                // G·ª≠i l√™n GAS
                await fetchGas("saveLesson", payload, "POST");
                
                if (currentEditingLessonId) {
                    // S·ª¨A: C·∫≠p nh·∫≠t trong m·∫£ng
                    const index = allLessons.findIndex(l => l.id === currentEditingLessonId);
                    if (index > -1) allLessons[index] = payload;
                } else {
                    // M·ªöI: Th√™m v√†o m·∫£ng
                    allLessons.push(payload);
                }
                
                showNotification("ƒê√£ l∆∞u b√†i h·ªçc th√†nh c√¥ng!", "success");
                renderLessons(); // C·∫≠p nh·∫≠t danh s√°ch b√†i h·ªçc
                renderExercises(); // C·∫≠p nh·∫≠t danh s√°ch b√†i t·∫≠p
                closeModal('lessonModal');
                document.getElementById('lessonForm').reset();
                currentEditingLessonId = null; // Reset
            } catch (error) {
                showNotification(`L·ªói khi l∆∞u b√†i h·ªçc: ${error.message}`, "error");
            }
        }
        
        function editLesson(id) {
            const lesson = allLessons.find(l => l.id === id);
            if (!lesson) {
                showNotification("Kh√¥ng t√¨m th·∫•y b√†i h·ªçc!", "error");
                return;
            }
            
            // 1. ƒê·∫∑t ID ƒëang s·ª≠a
            currentEditingLessonId = id;
            
            // 2. ƒêi·ªÅn d·ªØ li·ªáu v√†o form
            document.getElementById('lessonTitle').value = lesson.title;
            document.getElementById('lessonTopic').value = lesson.topic;
            document.getElementById('lessonGrade').value = lesson.grade;
            document.getElementById('lessonContent').value = lesson.content;
            
            // 3. M·ªü modal
            openModal('lessonModal');
        }
        
        async function deleteLesson(id) {
            // X√°c nh·∫≠n tr∆∞·ªõc khi x√≥a
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i h·ªçc n√†y? M·ªçi b√†i t·∫≠p li√™n quan c≈©ng s·∫Ω b·ªã x√≥a.")) {
                return;
            }
            
            showNotification("ƒêang x√≥a b√†i h·ªçc...", "info");
            
            try {
                await fetchGas("deleteLesson", { id: id }, "POST");
                
                // X√≥a kh·ªèi m·∫£ng local
                allLessons = allLessons.filter(l => l.id !== id);
                allExercises = allExercises.filter(ex => ex.lessonId !== id);
                
                showNotification("ƒê√£ x√≥a b√†i h·ªçc v√† c√°c b√†i t·∫≠p li√™n quan.", "success");
                
                renderLessons(); // C·∫≠p nh·∫≠t danh s√°ch b√†i h·ªçc
                renderExercises(); // C·∫≠p nh·∫≠t danh s√°ch b√†i t·∫≠p
            } catch (error) {
                showNotification(`L·ªói khi x√≥a: ${error.message}`, "error");
            }
        }
        
        // --- EXERCISES ---
        function renderExercises() {
            const list = document.getElementById('exercise-list');
            if (!list) return; // Ki·ªÉm tra an to√†n
            
            list.innerHTML = '';
            if (allExercises.length === 0) {
                list.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-gray-500">Ch∆∞a c√≥ b√†i t·∫≠p n√†o.</td></tr>'; // C·∫≠p nh·∫≠t colspan
                return;
            }
            
            allExercises.forEach(exercise => {
                const relatedLesson = allLessons.find(l => l.id === exercise.lessonId);
                const lessonTitle = relatedLesson ? relatedLesson.title : "Kh√¥ng r√µ";
                const grade = relatedLesson ? relatedLesson.grade : "N/A"; // L·∫•y kh·ªëi t·ª´ b√†i h·ªçc
                
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50";
                row.innerHTML = `
                    <td class="p-3 text-sm text-gray-700">${lessonTitle}</td>
                    <td class="p-3 text-sm text-gray-700">${exercise.questions.length}</td>
                    <td class="p-3 text-sm text-gray-700">${grade}</td> <!-- C·ªôt kh·ªëi m·ªõi -->
                    <td class="p-3 text-sm text-gray-700">
                        <button class="text-indigo-600 hover:text-indigo-800 opacity-50 cursor-not-allowed">S·ª≠a</button>
                        <button class="text-red-600 hover:text-red-800 ml-3 opacity-50 cursor-not-allowed">X√≥a</button>
                    </td>
                `;
                list.appendChild(row);
            });
        }

        function openExerciseModal(lessonId) {
            // X√≥a danh s√°ch c√¢u h·ªèi xem tr∆∞·ªõc c≈©
            exerciseQuestions = [];
            renderExerciseQuestions();
            document.getElementById('manualExerciseForm').reset();
            updateAnswerOptions();
            
            // T·ª± ƒë·ªông ch·ªçn b√†i h·ªçc n·∫øu c√≥
            if (lessonId) {
                document.getElementById('relatedLesson').value = lessonId;
            }
            
            // M·ªöI: Reset v·ªÅ tab ƒë·∫ßu ti√™n
            const tabContainer = document.querySelector('.exercise-tab-button');
            if (tabContainer) {
                switchTab('manual-exercise', '.exercise-tab-button', '.exercise-tab-content', tabContainer.closest('.border-b'));
            }
            
            openModal('exerciseModal');
        }

        function updateAnswerOptions() {
            const type = document.getElementById('questionType').value;
            const container = document.getElementById('answerOptionsContainer');
            const correctAnswerInput = document.getElementById('correctAnswer');
            
            if (!container || !correctAnswerInput) return; // Ki·ªÉm tra an to√†n
            
            container.innerHTML = '';
            if (type === 'multiple-choice') {
                container.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700">C√°c l·ª±a ch·ªçn (m·ªói l·ª±a ch·ªçn 1 d√≤ng)</label>
                    <textarea id="questionOptions" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                `;
                correctAnswerInput.placeholder = "Nh·∫≠p ch√≠nh x√°c 1 l·ª±a ch·ªçn ƒë√∫ng (v√≠ d·ª•: H√† N·ªôi)";
            } else if (type === 'true-false') {
                container.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700">L·ª±a ch·ªçn</label>
                    <div class="mt-1 space-y-2">
                        <label class="flex items-center"><input type="radio" name="tf" class="mr-2" checked> ƒê√∫ng</label>
                        <label class="flex items-center"><input type="radio" name="tf" class="mr-2"> Sai</label>
                    </div>
                `;
                correctAnswerInput.placeholder = "Nh·∫≠p 'ƒê√∫ng' ho·∫∑c 'Sai'";
            } else {
                correctAnswerInput.placeholder = "Nh·∫≠p ƒë√°p √°n ng·∫Øn ho·∫∑c ƒë·ªÉ tr·ªëng cho T·ª± lu·∫≠n";
            }
        }

        function addQuestion() {
            const text = document.getElementById('questionText').value;
            const type = document.getElementById('questionType').value;
            const correctAnswer = document.getElementById('correctAnswer').value;
            let options = [];

            if (!text) {
                showNotification("Vui l√≤ng nh·∫≠p n·ªôi dung c√¢u h·ªèi.", "warning");
                return;
            }
            
            if (type === 'multiple-choice') {
                const optionsEl = document.getElementById('questionOptions');
                if (optionsEl) {
                    options = optionsEl.value.split('\n').filter(opt => opt.trim() !== '');
                }
                if (options.length < 2) {
                    showNotification("C√¢u h·ªèi tr·∫Øc nghi·ªám c·∫ßn √≠t nh·∫•t 2 l·ª±a ch·ªçn.", "warning");
                    return;
                }
            } else if (type === 'true-false') {
                options = ["ƒê√∫ng", "Sai"];
            }

            exerciseQuestions.push({ text, type, options, correctAnswer: correctAnswer || "" });
            renderExerciseQuestions();
            
            // X√≥a form
            document.getElementById('questionText').value = '';
            document.getElementById('correctAnswer').value = '';
            const optionsEl = document.getElementById('questionOptions');
            if (optionsEl) {
                optionsEl.value = '';
            }
        }

        function renderExerciseQuestions() {
            const list = document.getElementById('exercisePreviewList');
            if (!list) return; // Ki·ªÉm tra an to√†n
            
            list.innerHTML = '';
            if (exerciseQuestions.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-500">Ch∆∞a c√≥ c√¢u h·ªèi n√†o...</p>';
                return;
            }
            
            exerciseQuestions.forEach((q, index) => {
                const item = document.createElement('div');
                item.className = "p-3 bg-white border rounded-md shadow-sm";
                item.innerHTML = `
                    <p class="text-sm font-medium text-gray-800">${index + 1}. ${q.text}</p>
                    <p class="text-xs text-gray-500">Lo·∫°i: ${q.type}</p>
                    ${q.options.length > 0 ? `<p class="text-xs text-gray-600">L·ª±a ch·ªçn: ${q.options.join(', ')}</p>` : ''}
                    <p class="text-xs text-green-700 font-medium">ƒê√°p √°n: ${q.correctAnswer}</p>
                `;
                list.appendChild(item);
            });
        }
        
        async function saveExercise(e) {
            e.preventDefault();
            const lessonId = document.getElementById('relatedLesson').value;
            if (!lessonId) {
                showNotification("Vui l√≤ng ch·ªçn b√†i h·ªçc li√™n quan.", "warning");
                return;
            }
            if (exerciseQuestions.length === 0) {
                showNotification("Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt c√¢u h·ªèi.", "warning");
                return;
            }
            
            const payload = {
                lessonId: parseInt(lessonId),
                questions: [...exerciseQuestions] // Sao ch√©p m·∫£ng
            };
            
            showNotification("ƒêang l∆∞u b√†i t·∫≠p...", "info");
            
            try {
                // G·ª≠i l√™n GAS
                await fetchGas("saveExercise", payload, "POST");
                
                // C·∫≠p nh·∫≠t local
                const index = allExercises.findIndex(ex => ex.lessonId === payload.lessonId);
                if (index > -1) {
                    allExercises[index] = payload;
                } else {
                    allExercises.push(payload);
                }
                
                renderExercises();
                closeModal('exerciseModal');
                showNotification(`ƒê√£ l∆∞u b√†i t·∫≠p v·ªõi ${exerciseQuestions.length} c√¢u h·ªèi.`, "success");
                
                // X√≥a b·ªô ƒë·ªám c√¢u h·ªèi
                exerciseQuestions = [];
                
            } catch (error) {
                showNotification(`L·ªói khi l∆∞u b√†i t·∫≠p: ${error.message}`, "error");
            }
        }

        // --- M·ªöI: Th√™m l·∫°i c√°c h√†m x·ª≠ l√Ω file Word ---
        function handleFileSelect(e) {
            const file = e.target.files?.[0];
            if (file) {
                processFile(file);
            }
            // Clear the file input to allow selecting the same file again
            e.target.value = null;
        }

        function handleFileDrop(e) {
            e.preventDefault();
            const fileUploadArea = document.getElementById('fileUploadArea');
            fileUploadArea.classList.remove('dragover');
            const file = e.dataTransfer?.files?.[0];
            if (file) {
                if (file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document" || file.name.endsWith('.docx')) {
                    processFile(file);
                } else {
                    showNotification('Ch·ªâ ch·∫•p nh·∫≠n t·ªáp .docx', 'warning');
                }
            }
        }

        function processFile(file) {
            showNotification(`ƒêang ƒë·ªçc t·ªáp ${file.name}...`, 'info');
            const reader = new FileReader();
            reader.onload = function(event) {
                const arrayBuffer = event.target.result;
                mammoth.extractRawText({ arrayBuffer: arrayBuffer })
                    .then(result => {
                        const parsedQuestions = parseWordContent(result.value);
                        if (parsedQuestions.length > 0) {
                            exerciseQuestions.push(...parsedQuestions);
                            renderExerciseQuestions();
                            showNotification(`Ph√¢n t√≠ch th√†nh c√¥ng! ƒê√£ th√™m ${parsedQuestions.length} c√¢u h·ªèi.`, 'success');
                            // Switch to manual tab to show results
                            const tabContainer = document.querySelector('.exercise-tab-button');
                            if (tabContainer) {
                                switchTab('manual-exercise', '.exercise-tab-button', '.exercise-tab-content', tabContainer.closest('.border-b'));
                            }
                        } else {
                            showNotification('Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o trong t·ªáp. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng.', 'warning');
                        }
                    })
                    .catch(err => {
                        console.error('L·ªói ƒë·ªçc file Word:', err);
                        showNotification('Kh√¥ng th·ªÉ ƒë·ªçc t·ªáp .docx n√†y.', 'error');
                    });
            };
            reader.readAsArrayBuffer(file);
        }
        
        function parseWordContent(text) {
            const questions = [];
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            let currentType = null;
            let currentQuestion = null;
            let parsingAnswers = false;
            const answerMap = {};
            let questionCounter = 0; // To track "C√¢u 1, 2, 3..."

            const romanNumerals = {
                "I.": "multiple-choice",
                "II.": "true-false",
                "III.": "short-answer",
                "IV.": "essay",
                "V.": "answers"
            };
            
            const optionRegex = /^[A-D]\.\s*(.*)/i; // Matches A. B. C. D.
            const questionRegex = /^(C√¢u \d+:|C√¢u \d+\.|^\d+\.)\s*(.*)/i; // Matches C√¢u 1:, 1.
            const answerRegex = /^(\d+)\.\s*(.*)/; // Matches "1. A", "3. Sai" in Section V

            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine) continue;

                // Check for new section header (I., II., etc.)
                const sectionMatch = Object.keys(romanNumerals).find(key => 
                    trimmedLine.toUpperCase().startsWith(key)
                );
                
                if (sectionMatch) {
                    if (currentQuestion) questions.push(currentQuestion); // Save last question
                    
                    currentType = romanNumerals[sectionMatch];
                    currentQuestion = null;
                    
                    if (currentType === "answers") {
                        parsingAnswers = true;
                    }
                    continue;
                }

                if (parsingAnswers) {
                    // We are in Section V, parsing answers
                    const answerMatch = trimmedLine.match(answerRegex);
                    if (answerMatch) {
                        const qNum = answerMatch[1];
                        const qAns = answerMatch[2].trim();
                        answerMap[qNum] = qAns;
                    }
                } else if (currentType) {
                    // We are in a question section (I, II, III, IV)
                    const questionMatch = trimmedLine.match(questionRegex);
                    const optionMatch = trimmedLine.match(optionRegex);
                    
                    if (questionMatch) {
                        if (currentQuestion) questions.push(currentQuestion); // Save previous
                        
                        questionCounter++;
                        currentQuestion = {
                            id: `file-q-${questionCounter}`, // temp ID
                            text: questionMatch[2].trim(), // Text after "C√¢u 1: "
                            type: currentType,
                            options: [],
                            correctAnswer: [] // Will be filled later
                        };
                    } else if (currentQuestion && (currentType === 'multiple-choice') && optionMatch) {
                        // This is an option (A, B, C, D)
                        currentQuestion.options.push(optionMatch[1].trim());
                    } else if (currentQuestion && !optionMatch) {
                        // This is a continuation of the question text (e.g., a new paragraph)
                        currentQuestion.text += '\n' + trimmedLine;
                    }
                }
            }
            
            if (currentQuestion) questions.push(currentQuestion); // Push the last one
            
            // Now, map the answers from Section V back to the questions
            questions.forEach((q, index) => {
                const qNum = (index + 1).toString(); // "1", "2", "3"
                const answer = answerMap[qNum]; // e.g., "A", "Sai", "Au"
                
                if (answer) {
                    if (q.type === 'multiple-choice') {
                        // Answer is "A", "B", etc. Find the corresponding option text.
                        const optionIndex = answer.toUpperCase().charCodeAt(0) - 'A'.charCodeAt(0); // A=0, B=1...
                        if (q.options[optionIndex]) {
                            q.correctAnswer = [q.options[optionIndex]];
                        }
                    } else if (q.type === 'true-false') {
                        // Answer is "ƒê√∫ng" or "Sai". Add these as options if they don't exist
                        if (!q.options.includes("ƒê√∫ng")) q.options.push("ƒê√∫ng");
                        if (!q.options.includes("Sai")) q.options.push("Sai");
                        q.correctAnswer = [answer];
                    } else if (q.type === 'short-answer') {
                        // Answer is the text itself
                        q.correctAnswer = [answer];
                    }
                    // 'essay' type has no "correct" answer
                }
            });
            
            // Return in the simple format used by exerciseQuestions array
            return questions.map(q => ({
                text: q.text,
                type: q.type,
                options: q.options,
                correctAnswer: q.correctAnswer.length > 0 ? q.correctAnswer[0] : ""
            }));
        }


        // --- GAME (M·ªöI: C·∫≠p nh·∫≠t l∆∞u tr·ªØ) ---
        
        async function saveMemoryGame() {
            const title = document.getElementById('memoryGameTitle').value;
            const pairs = document.getElementById('gamePairs').value;
            
            if (!title || !pairs) {
                showNotification("Vui l√≤ng nh·∫≠p Ti√™u ƒë·ªÅ v√† C√°c c·∫∑p th·∫ª.", "warning");
                return;
            }
            
            const payload = {
                id: new Date().getTime(),
                title: title,
                type: 'memory',
                data: { pairs: pairs.split('\n').filter(p => p.includes(':')) } // L∆∞u c√°c c·∫∑p
            };
            
            showNotification("ƒêang l∆∞u tr√≤ ch∆°i...", "info");
            try {
                await fetchGas("saveGame", payload, "POST");
                allGames.push(payload); // Th√™m v√†o m·∫£ng local
                showNotification("ƒê√£ l∆∞u Tr√≤ ch∆°i L·∫≠t th·∫ª!", "success");
                closeModal('memoryGameModal');
                document.getElementById('memoryGameForm').reset();
            } catch (error) {
                showNotification(`L·ªói khi l∆∞u game: ${error.message}`, "error");
            }
        }
        
        function previewCustomGame() {
            const html = document.getElementById('gameHtml').value;
            const css = document.getElementById('gameCss').value;
            const js = document.getElementById('gameJs').value;
            
            const iframe = document.getElementById('gamePreviewFrame');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            iframeDoc.open();
            iframeDoc.write(`
                <html>
                <head>
                    <style>${css}</style>
                </head>
                <body>
                    ${html}
                    <script>${js}<\/script>
                </body>
                </html>
            `);
            iframeDoc.close();
        }
        
        async function saveCustomGame() {
            const title = document.getElementById('gameTitle').value;
            if (!title) {
                showNotification("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ cho tr√≤ ch∆°i.", "warning");
                return;
            }
            
            const payload = {
                id: new Date().getTime(),
                title: title,
                type: 'custom',
                data: {
                    html: document.getElementById('gameHtml').value,
                    css: document.getElementById('gameCss').value,
                    js: document.getElementById('gameJs').value
                }
            };
            
            showNotification("ƒêang l∆∞u tr√≤ ch∆°i...", "info");
            try {
                await fetchGas("saveGame", payload, "POST");
                allGames.push(payload); // Th√™m v√†o m·∫£ng local
                showNotification("ƒê√£ l∆∞u Tr√≤ ch∆°i T√πy ch·ªânh!", "success");
                closeModal('customGameModal');
                document.getElementById('customGameForm').reset();
                document.getElementById('gamePreviewFrame').src = 'about:blank';
            } catch (error) {
                showNotification(`L·ªói khi l∆∞u game: ${error.message}`, "error");
            }
        }
        
        // --- GOOGLE SHEETS ---
        // (ƒê√£ x√≥a, v√¨ kh√¥ng c√≤n d√πng n√∫t import/export)
        
        // --- AI TUTOR (ADMIN) ---
        async function handleAIChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('ai-chat-input');
            const chatBox = document.getElementById('ai-chat-box');
            const query = input.value.trim();
            const grade = document.getElementById('admin-ai-grade').value; // L·∫•y kh·ªëi l·ªõp
            
            if (!query) return;
            
            // Display user message
            addMessageToChatbox(chatBox, query, 'user');
            input.value = '';
            
            // Display loading
            const loadingId = 'admin-loading-' + Date.now();
            addMessageToChatbox(chatBox, '<i class="fas fa-spinner fa-spin"></i>', 'ai', loadingId);
            
            try {
                // Th√™m kh·ªëi l·ªõp v√†o system prompt
                const systemPrompt = `B·∫°n l√† m·ªôt gia s∆∞ AI th√¢n thi·ªán, chuy√™n gi·∫£i th√≠ch c√°c kh√°i ni·ªám khoa h·ªçc t·ª± nhi√™n (L√Ω, H√≥a, Sinh) cho h·ªçc sinh. H√£y ƒëi·ªÅu ch·ªânh c√¢u tr·∫£ l·ªùi cho ph√π h·ª£p v·ªõi tr√¨nh ƒë·ªô ${grade}. Tr·∫£ l·ªùi ng·∫Øn g·ªçn, t·∫≠p trung v√†o c√¢u h·ªèi.`;
                const response = await callGemini(query, systemPrompt);
                addMessageToChatbox(chatBox, response, 'ai', null, loadingId);
            } catch (error) {
                addMessageToChatbox(chatBox, `Xin l·ªói, t√¥i g·∫∑p s·ª± c·ªë. (${error.message})`, 'ai-error', null, loadingId);
            }
        }
        
        // --- AI TUTOR (STUDENT) ---
        async function handleStudentAIChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('student-ai-chat-input');
            const chatBox = document.getElementById('student-ai-chat-box');
            const query = input.value.trim();
            const grade = document.getElementById('student-ai-grade').value; // L·∫•y kh·ªëi l·ªõp
            
            if (!query) return;

            addMessageToChatbox(chatBox, query, 'user');
            input.value = '';

            const loadingId = 'student-loading-' + Date.now();
            addMessageToChatbox(chatBox, '<i class="fas fa-spinner fa-spin"></i>', 'ai', loadingId);
            
            try {
                // Th√™m kh·ªëi l·ªõp v√†o system prompt
                const systemPrompt = `B·∫°n l√† m·ªôt gia s∆∞ AI th√¢n thi·ªán, chuy√™n gi·∫£i th√≠ch c√°c kh√°i ni·ªám khoa h·ªçc t·ª± nhi√™n (L√Ω, H√≥a, Sinh) cho h·ªçc sinh. H√£y ƒëi·ªÅu ch·ªânh c√¢u tr·∫£ l·ªùi cho ph√π h·ª£p v·ªõi tr√¨nh ƒë·ªô ${grade}. Tr·∫£ l·ªùi ng·∫Øn g·ªçn, t·∫≠p trung v√†o c√¢u h·ªèi.`;
                const response = await callGemini(query, systemPrompt);
                addMessageToChatbox(chatBox, response, 'ai', null, loadingId);
            } catch (error) {
                addMessageToChatbox(chatBox, `Xin l·ªói, t√¥i g·∫∑p s·ª± c·ªë. (${error.message})`, 'ai-error', null, loadingId);
            }
        }
        
        function addMessageToChatbox(chatBox, text, userType, id = null, replaceId = null) {
            let messageHtml = '';
            
            if (userType === 'user') {
                messageHtml = `
                    <div class="flex justify-end">
                        <div class="p-3 rounded-lg bg-indigo-600 text-white max-w-lg">
                            <p>${text}</p>
                        </div>
                    </div>
                `;
            } else {
                let bubbleClass = 'bg-gray-100 text-gray-800';
                if (userType === 'ai-error') bubbleClass = 'bg-red-100 text-red-700';
                
                messageHtml = `
                    <div class="flex justify-start" ${id ? `id="${id}"` : ''}>
                        <div class="p-3 rounded-lg ${bubbleClass} max-w-lg">
                            <p>${text.replace(/\n/g, '<br>')}</p>
                        </div>
                    </div>
                `;
            }
            
            if (replaceId) {
                document.getElementById(replaceId)?.remove();
            }
            
            if (chatBox) { // Ki·ªÉm tra an to√†n
                chatBox.innerHTML += messageHtml;
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        
        // --- STUDENT VIEW ---
        
        // M·ªöI: Th√™m h√†m render B·∫£ng x·∫øp h·∫°ng cho Admin
        function renderAdminLeaderboard(gradeFilter = 'all') {
            const list = document.getElementById('admin-leaderboard-list');
            if (!list) return; // Kh√¥ng l√†m g√¨ n·∫øu view ch∆∞a load
            
            list.innerHTML = '';
            
            let studentsToDisplay = [...allStudents];
            
            if (gradeFilter && gradeFilter !== 'all') {
                studentsToDisplay = studentsToDisplay.filter(s => s.class.startsWith(gradeFilter));
            }
            
            // S·∫Øp x·∫øp theo XP
            studentsToDisplay.sort((a, b) => b.xp - a.xp);
            
            if (studentsToDisplay.length === 0) {
                list.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-gray-500">Kh√¥ng c√≥ h·ªçc sinh n√†o.</td></tr>';
                return;
            }
            
            studentsToDisplay.forEach((student, index) => {
                const rank = index + 1;
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50";
                row.innerHTML = `
                    <td class="p-3 text-sm text-gray-700 font-bold">${rank}</td>
                    <td class="p-3 text-sm text-gray-700">${student.name}</td>
                    <td class="p-3 text-sm text-gray-700">${student.class}</td>
                    <td class="p-3 text-sm text-gray-700 font-medium text-indigo-600">${student.xp}</td>
                `;
                list.appendChild(row);
            });
        }
        
        function updateStudentView() {
            if (!currentStudent) return;
            
            // C·∫≠p nh·∫≠t c√°c ch·ªâ s·ªë
            document.getElementById('student-name-header').textContent = currentStudent.name;
            document.getElementById('student-welcome').textContent = `Ch√†o m·ª´ng, ${currentStudent.name}!`;
            document.getElementById('student-xp').textContent = currentStudent.xp;
            document.getElementById('student-streak').innerHTML = `üî• ${currentStudent.streak}`;
            
            // Render achievements
            const achievementContainer = document.getElementById('student-achievements-list');
            if (achievementContainer) {
                achievementContainer.innerHTML = '';
                if (allAchievements.length === 0) {
                     achievementContainer.innerHTML = `<p class="text-gray-500">Ch∆∞a c√≥ th√†nh t√≠ch n√†o.</p>`;
                }
                allAchievements.forEach(ach => {
                    const isEarned = currentStudent.achievements.some(sa => sa.id === ach.id);
                    const achElement = document.createElement('div');
                    achElement.className = `text-center p-4 rounded-lg ${isEarned ? 'bg-yellow-100 border border-yellow-300' : 'bg-gray-100 opacity-60'}`;
                    achElement.innerHTML = `
                        <i class="fas ${ach.icon} text-3xl ${isEarned ? 'text-yellow-600' : 'text-gray-500'}"></i>
                        <p class="text-sm font-medium mt-2 ${isEarned ? 'text-yellow-800' : 'text-gray-600'}">${ach.title}</p>
                    `;
                    achievementContainer.appendChild(achElement);
                });
            }
            
            // C·∫≠p nh·∫≠t l·∫°i danh s√°ch b√†i h·ªçc
            renderLessons();
            // C·∫≠p nh·∫≠t b·∫£ng x·∫øp h·∫°ng
            renderLeaderboard();
            
            // C·∫≠p nh·∫≠t h·∫°ng ·ªü dashboard
            const currentGrade = currentStudent.class.charAt(0);
            const gradeStudents = allStudents.filter(s => s.class.startsWith(currentGrade));
            gradeStudents.sort((a, b) => b.xp - a.xp);
            const currentRank = (gradeStudents.findIndex(s => s.id === currentStudent.id) + 1) || 0;
            document.getElementById('student-rank').textContent = `#${currentRank}`;
        }
        
        function renderLeaderboard() {
            if (!currentStudent) return;
            
            const leaderboardContainer = document.getElementById('student-leaderboard');
            const titleEl = document.getElementById('leaderboard-title');
            
            if (!leaderboardContainer || !titleEl) return; // Ki·ªÉm tra an to√†n
            
            const currentGrade = currentStudent.class.charAt(0); // "6", "7", "8", or "9"
            titleEl.textContent = `X·∫øp h·∫°ng Kh·ªëi ${currentGrade}`;
            
            // L·ªçc v√† s·∫Øp x·∫øp
            const gradeStudents = allStudents
                .filter(s => s.class.startsWith(currentGrade))
                .sort((a, b) => b.xp - a.xp); // S·∫Øp x·∫øp XP gi·∫£m d·∫ßn
                
            leaderboardContainer.innerHTML = ''; // X√≥a c≈©
            
            if(gradeStudents.length === 0) {
                leaderboardContainer.innerHTML = `<p class="text-gray-500">Ch∆∞a c√≥ ai trong b·∫£ng x·∫øp h·∫°ng n√†y.</p>`;
                return;
            }
            
            gradeStudents.forEach((student, index) => {
                const rank = index + 1;
                const isCurrentUser = (student.id === currentStudent.id);
                
                const row = document.createElement('div');
                row.className = `flex items-center justify-between p-3 rounded-lg ${isCurrentUser ? 'bg-yellow-100 border border-yellow-300' : 'bg-gray-50'}`;
                row.innerHTML = `
                    <div class="flex items-center">
                        <span class="font-bold w-6 text-lg ${rank === 1 ? 'text-yellow-500' : (rank === 2 ? 'text-gray-400' : (rank === 3 ? 'text-orange-400' : 'text-gray-600'))}">${rank}</span>
                        <span class="font-medium ml-3 ${isCurrentUser ? 'text-indigo-700' : 'text-gray-800'}">${student.name}</span>
                    </div>
                    <span class="font-bold text-indigo-600">${student.xp} XP</span>
                `;
                leaderboardContainer.appendChild(row);
            });
        }
        
        function viewStudentLesson(lessonId) {
            const lesson = allLessons.find(l => l.id === lessonId);
            if (!lesson) return;
            
            document.getElementById('studentLessonTitle').textContent = lesson.title;
            document.getElementById('studentLessonContent').innerHTML = lesson.content || "<p>N·ªôi dung b√†i h·ªçc n√†y ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t...</p>";
            document.getElementById('completeLessonBtn').dataset.lessonId = lessonId;
            
            openModal('studentLessonModal');
        }
        
        async function completeStudentLesson() {
            if (!currentStudent) return;
            const lessonId = parseInt(document.getElementById('completeLessonBtn').dataset.lessonId);
            
            if (!currentStudent.completedLessons.includes(lessonId)) {
                currentStudent.completedLessons.push(lessonId);
                currentStudent.xp += 60; // <<< ƒêI·ªÇM XP
                
                showNotification("ƒêang l∆∞u ti·∫øn ƒë·ªô... +60 XP", "info");
                
                try {
                    // L∆∞u l√™n Google Sheet
                    await fetchGas("saveStudent", currentStudent, "POST");
                    showNotification("Ho√†n th√†nh b√†i h·ªçc! +60 XP", "success");
                    updateStudentView(); // C·∫≠p nh·∫≠t l·∫°i to√†n b·ªô view h·ªçc sinh
                } catch (error) {
                    // Ho√†n t√°c n·∫øu l·ªói
                    currentStudent.xp -= 60;
                    currentStudent.completedLessons.pop();
                    showNotification(`L·ªói khi l∆∞u ti·∫øn ƒë·ªô: ${error.message}`, "error");
                }
            }
            closeModal('studentLessonModal');
        }
        
        function doStudentExercise(lessonId) {
            if (!currentStudent) return;
            
            // 1. T√¨m b√†i t·∫≠p t∆∞∆°ng ·ª©ng
            const exercise = allExercises.find(ex => ex.lessonId === lessonId);
            const lesson = allLessons.find(l => l.id === lessonId);
            
            if (!exercise || exercise.questions.length === 0) {
                showNotification("Ch∆∞a c√≥ b√†i t·∫≠p cho b√†i h·ªçc n√†y.", "warning");
                return;
            }
            
            // 2. Kh·ªüi t·∫°o state l√†m b√†i
            currentQuiz = exercise.questions;
            currentQuestionIndex = 0;
            userAnswers = new Array(currentQuiz.length).fill(null); // M·∫£ng ƒë·ªÉ l∆∞u { answer, isCorrect }
            currentQuizLessonId = lessonId; // L∆∞u ID b√†i h·ªçc
            
            // 3. C·∫≠p nh·∫≠t UI modal
            document.getElementById('studentExerciseTitle').textContent = `B√†i t·∫≠p: ${lesson.title}`;
            
            // 4. Render c√¢u h·ªèi ƒë·∫ßu ti√™n
            renderCurrentQuestion();
            
            // 5. M·ªü modal
            openModal('studentExerciseModal');
        }

        // --- M·ªöI: C√ÅC H√ÄM X·ª¨ L√ù L√ÄM B√ÄI T·∫¨P ---

        function renderCurrentQuestion() {
            const question = currentQuiz[currentQuestionIndex];
            const container = document.getElementById('currentQuestionContainer');
            const feedbackEl = document.getElementById('questionFeedback');
            
            // Reset container state
            container.classList.remove('answered');
            feedbackEl.classList.add('hidden');
            feedbackEl.classList.remove('shake-incorrect');
            
            // C·∫≠p nh·∫≠t thanh ti·∫øn tr√¨nh
            const progressPercent = ((currentQuestionIndex + 1) / currentQuiz.length) * 100;
            document.getElementById('exerciseProgress').textContent = `C√¢u ${currentQuestionIndex + 1} / ${currentQuiz.length}`;
            document.getElementById('exerciseProgressBar').style.width = `${progressPercent}%`;
            
            // C·∫≠p nh·∫≠t n·ªôi dung c√¢u h·ªèi
            document.getElementById('questionText').textContent = question.text;
            
            // L·∫•y c√°c element khu v·ª±c tr·∫£ l·ªùi
            const optionsEl = document.getElementById('answerOptions');
            const shortAnswerEl = document.getElementById('shortAnswerContainer');
            const essayEl = document.getElementById('essayContainer');
            
            // X√≥a v√† ·∫©n t·∫•t c·∫£
            optionsEl.innerHTML = '';
            shortAnswerEl.classList.add('hidden');
            essayEl.classList.add('hidden');
            
            // Hi·ªÉn th·ªã n√∫t "Ki·ªÉm tra" (m·∫∑c ƒë·ªãnh)
            document.getElementById('checkAnswerBtn').classList.remove('hidden');

            // Render theo lo·∫°i c√¢u h·ªèi
            switch (question.type) {
                case 'multiple-choice':
                case 'true-false':
                    question.options.forEach(option => {
                        const optionBtn = document.createElement('button');
                        optionBtn.className = "answer-option w-full text-left p-4 border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition-colors";
                        optionBtn.textContent = option;
                        optionBtn.dataset.option = option; // L∆∞u gi√° tr·ªã ƒë√°p √°n
                        optionBtn.onclick = () => {
                            // B·ªè ch·ªçn t·∫•t c·∫£
                            optionsEl.querySelectorAll('.answer-option').forEach(btn => btn.classList.remove('selected'));
                            // Ch·ªçn c√°i n√†y
                            optionBtn.classList.add('selected');
                        };
                        optionsEl.appendChild(optionBtn);
                    });
                    break;
                case 'short-answer':
                    shortAnswerEl.classList.remove('hidden');
                    document.getElementById('shortAnswerInput').value = ''; // X√≥a input c≈©
                    break;
                case 'essay':
                    essayEl.classList.remove('hidden');
                    document.getElementById('essayInput').value = ''; // X√≥a input c≈©
                    document.getElementById('checkAnswerBtn').classList.add('hidden'); // Kh√¥ng t·ª± ƒë·ªông ch·∫•m T·ª± lu·∫≠n
                    break;
            }
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n·∫øu c√¢u n√†y ƒë√£ ƒë∆∞·ª£c tr·∫£ l·ªùi
            const answered = userAnswers[currentQuestionIndex];
            if (answered) {
                container.classList.add('answered');
                document.getElementById('checkAnswerBtn').classList.add('hidden');
                
                // Hi·ªÉn th·ªã l·∫°i feedback
                showFeedback(answered.isCorrect, question.correctAnswer);
                
                // Kh√¥i ph·ª•c l·ª±a ch·ªçn c·ªßa ng∆∞·ªùi d√πng
                if (question.type === 'multiple-choice' || question.type === 'true-false') {
                    const selectedBtn = optionsEl.querySelector(`[data-option="${answered.answer}"]`);
                    if (selectedBtn) {
                        selectedBtn.classList.add('selected');
                        if (!answered.isCorrect) {
                            selectedBtn.classList.add('incorrect-selection');
                        }
                    }
                    // T√¥ m√†u ƒë√°p √°n ƒë√∫ng
                    const correctBtn = optionsEl.querySelector(`[data-option="${question.correctAnswer}"]`);
                    if (correctBtn) {
                        correctBtn.classList.add('correct');
                    }
                } else if (question.type === 'short-answer') {
                    document.getElementById('shortAnswerInput').value = answered.answer;
                    document.getElementById('shortAnswerInput').disabled = true;
                }
            } else {
                // N·∫øu ch∆∞a tr·∫£ l·ªùi, reset
                if (question.type === 'short-answer') {
                    document.getElementById('shortAnswerInput').disabled = false;
                }
            }

            // ƒêi·ªÅu khi·ªÉn n√∫t ƒëi·ªÅu h∆∞·ªõng
            document.getElementById('prevQuestionBtn').classList.toggle('hidden', currentQuestionIndex === 0);
            document.getElementById('nextQuestionBtn').classList.toggle('hidden', currentQuestionIndex === currentQuiz.length - 1);
            document.getElementById('finishQuizBtn').classList.toggle('hidden', currentQuestionIndex !== currentQuiz.length - 1);
        }

        function checkCurrentAnswer() {
            const question = currentQuiz[currentQuestionIndex];
            const container = document.getElementById('currentQuestionContainer');
            
            // N·∫øu ƒë√£ tr·∫£ l·ªùi, kh√¥ng l√†m g√¨ c·∫£
            if (container.classList.contains('answered')) return;

            let userAnswer = null;
            let isCorrect = false;

            if (question.type === 'multiple-choice' || question.type === 'true-false') {
                const selectedOption = document.getElementById('answerOptions').querySelector('.selected');
                if (!selectedOption) {
                    showNotification("Vui l√≤ng ch·ªçn m·ªôt ƒë√°p √°n!", "warning");
                    return;
                }
                userAnswer = selectedOption.dataset.option;
                isCorrect = userAnswer.toLowerCase() === question.correctAnswer.toLowerCase();
                
                // Hi·ªáu ·ª©ng
                if (isCorrect) {
                    selectedOption.classList.add('correct');
                } else {
                    selectedOption.classList.add('incorrect-selection');
                    const correctBtn = document.getElementById('answerOptions').querySelector(`[data-option="${question.correctAnswer}"]`);
                    if (correctBtn) correctBtn.classList.add('correct');
                }

            } else if (question.type === 'short-answer') {
                const inputEl = document.getElementById('shortAnswerInput');
                userAnswer = inputEl.value.trim();
                if (userAnswer === "") {
                    showNotification("Vui l√≤ng nh·∫≠p c√¢u tr·∫£ l·ªùi!", "warning");
                    return;
                }
                isCorrect = userAnswer.toLowerCase() === question.correctAnswer.toLowerCase();
                inputEl.disabled = true; // V√¥ hi·ªáu h√≥a input
                
                // Hi·ªáu ·ª©ng
                if (isCorrect) {
                    inputEl.classList.add('border-green-500', 'bg-green-50');
                } else {
                    inputEl.classList.add('border-red-500', 'bg-red-50');
                }
            }
            
            // L∆∞u k·∫øt qu·∫£
            userAnswers[currentQuestionIndex] = { answer: userAnswer, isCorrect: isCorrect };
            
            // ƒê√°nh d·∫•u ƒë√£ tr·∫£ l·ªùi
            container.classList.add('answered');
            document.getElementById('checkAnswerBtn').classList.add('hidden');
            
            // Hi·ªÉn th·ªã ph·∫£n h·ªìi
            showFeedback(isCorrect, question.correctAnswer);
        }

        function showFeedback(isCorrect, correctAnswer) {
            const feedbackEl = document.getElementById('questionFeedback');
            feedbackEl.classList.remove('hidden');
            
            if (isCorrect) {
                feedbackEl.className = 'mt-4 p-4 rounded-md bg-green-100 text-green-700 font-medium';
                feedbackEl.innerHTML = '<i class="fas fa-check-circle mr-2"></i>ƒê√∫ng r·ªìi!';
            } else {
                feedbackEl.className = 'mt-4 p-4 rounded-md bg-red-100 text-red-700 font-medium shake-incorrect';
                feedbackEl.innerHTML = `<i class="fas fa-times-circle mr-2"></i>Sai r·ªìi! ƒê√°p √°n ƒë√∫ng l√†: <strong>${correctAnswer}</strong>`;
            }
        }
        
        function nextQuestion() {
            if (currentQuestionIndex < currentQuiz.length - 1) {
                currentQuestionIndex++;
                renderCurrentQuestion();
            }
        }
        
        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderCurrentQuestion();
            }
        }
        
        async function finishQuiz() {
            if (!currentStudent) return;
            
            // ƒê·∫øm s·ªë c√¢u ƒë√∫ng (ch·ªâ ƒë·∫øm c√°c lo·∫°i t·ª± ƒë·ªông ch·∫•m)
            const autoGradedQuestions = currentQuiz.filter(q => q.type !== 'essay');
            const correctCount = userAnswers.filter(a => a && a.isCorrect).length;
            const totalAutoGraded = autoGradedQuestions.length;
            
            let xpGained = 0;
            let message = "";

            if (totalAutoGraded > 0) {
                if (correctCount === totalAutoGraded) {
                    xpGained = 140; // ƒêi·ªÉm t·ªëi ƒëa
                    message = `Ho√†n th√†nh xu·∫•t s·∫Øc! B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£ ${totalAutoGraded} c√¢u! +140 XP`;
                } else {
                    xpGained = Math.floor((correctCount / totalAutoGraded) * 140);
                    message = `Ho√†n th√†nh! B·∫°n ƒë√∫ng ${correctCount} / ${totalAutoGraded} c√¢u. +${xpGained} XP`;
                }
            } else {
                message = "ƒê√£ n·ªôp b√†i t·ª± lu·∫≠n. Ch·ªù gi√°o vi√™n ch·∫•m.";
            }

            // Th√™m XP
            currentStudent.xp += xpGained;
            // Th√™m b√†i h·ªçc v√†o danh s√°ch ƒë√£ ho√†n th√†nh (n·∫øu ch∆∞a)
            if (!currentStudent.completedLessons.includes(currentQuizLessonId)) {
                currentStudent.completedLessons.push(currentQuizLessonId);
            }
            
            showNotification(message, xpGained > 0 ? "success" : "info");
            showNotification("ƒêang l∆∞u ti·∫øn ƒë·ªô...", "info");

            try {
                // L∆∞u l√™n Google Sheet
                await fetchGas("saveStudent", currentStudent, "POST");
                showNotification("ƒê√£ l∆∞u ti·∫øn ƒë·ªô th√†nh c√¥ng!", "success");
                
                // C·∫≠p nh·∫≠t view v√† ƒë√≥ng modal
                updateStudentView();
                closeModal('studentExerciseModal');
            } catch (error) {
                // Ho√†n t√°c n·∫øu l·ªói
                currentStudent.xp -= xpGained;
                // (Vi·ªác ho√†n t√°c completedLessons ph·ª©c t·∫°p h∆°n, t·∫°m b·ªè qua)
                showNotification(`L·ªói khi l∆∞u ti·∫øn ƒë·ªô: ${error.message}`, "error");
            }
            
            // Reset state
            currentQuiz = [];
            currentQuestionIndex = 0;
            userAnswers = [];
            currentQuizLessonId = null;
        }

        // --- M·ªöI: H√ÄM D√ÄNH CHO STUDENT GAME CORNER ---
        
        function renderStudentGames() {
            const listEl = document.getElementById('student-game-list');
            if (!listEl) return;
            listEl.innerHTML = '';
            
            if (allGames.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500 col-span-full text-center">Admin ch∆∞a t·∫°o tr√≤ ch∆°i n√†o.</p>`;
                return;
            }
            
            allGames.forEach(game => {
                const icon = game.type === 'memory' ? 'fa-brain' : 'fa-code';
                const color = game.type === 'memory' ? 'from-indigo-500 to-purple-600' : 'from-green-500 to-teal-600';
                
                const card = document.createElement('div');
                card.className = `p-6 rounded-lg text-white shadow-lg cursor-pointer transform hover:-translate-y-1 transition-transform bg-gradient-to-br ${color}`;
                card.innerHTML = `
                    <i class="fas ${icon} text-4xl mb-3"></i>
                    <h3 class="text-2xl font-bold mb-2">${game.title}</h3>
                `;
                card.onclick = () => playGame(game.id);
                listEl.appendChild(card);
            });
        }
        
        function playGame(gameId) {
            const game = allGames.find(g => g.id === gameId);
            if (!game) return;
            
            const titleEl = document.getElementById('gamePlayTitle');
            const frameEl = document.getElementById('gamePlayFrame');
            const memoryEl = document.getElementById('gamePlayMemoryBoard');
            
            titleEl.textContent = game.title;
            
            // ·∫®n c·∫£ hai tr∆∞·ªõc
            frameEl.classList.add('hidden');
            memoryEl.classList.add('hidden');
            frameEl.src = 'about:blank'; // Reset iframe

            if (game.type === 'custom') {
                frameEl.classList.remove('hidden');
                const iframeDoc = frameEl.contentDocument || frameEl.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(`
                    <html>
                    <head>
                        <style>${game.data.css}</style>
                    </head>
                    <body>
                        ${game.data.html}
                        <script>${game.data.js}<\/script>
                    </body>
                    </html>
                `);
                iframeDoc.close();
            } else if (game.type === 'memory') {
                memoryEl.classList.remove('hidden');
                // G·ªçi h√†m kh·ªüi t·∫°o memory game (b·∫°n c√≥ th·ªÉ b·ªï sung logic n√†y)
                memoryEl.innerHTML = `<p class="text-center col-span-full">Logic cho game l·∫≠t th·∫ª s·∫Ω ·ªü ƒë√¢y...</p>`;
            }
            
            openModal('gamePlayModal');
        }

    </script>
</body>
</html>